<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Controle de Agendamentos</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0a1929;
            min-height: 100vh;
            padding: 20px;
            color: #e0e0e0;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: #1a2332;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
            overflow: hidden;
            border: 1px solid #2a3544;
        }
        
        .header {
            background: linear-gradient(135deg, #0a1929 0%, #1a2332 100%);
            color: #d4af37;
            padding: 30px;
            border-bottom: 2px solid #d4af37;
        }
        
        .header h1 {
            font-size: 2em;
            margin-bottom: 5px;
            font-weight: 600;
            letter-spacing: 1px;
        }
        
        .header p {
            color: #b0b0b0;
            font-size: 0.95em;
        }
        
        .tabs {
            display: flex;
            background: #0f1620;
            border-bottom: 1px solid #2a3544;
        }
        
        .tab {
            flex: 1;
            padding: 18px;
            text-align: center;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
            border: none;
            background: none;
            font-size: 0.95em;
            color: #b0b0b0;
            border-bottom: 3px solid transparent;
        }
        
        .tab:hover {
            background: #1a2332;
            color: #d4af37;
        }
        
        .tab.active {
            background: #1a2332;
            color: #d4af37;
            border-bottom: 3px solid #d4af37;
        }
        
        .tab-content {
            display: none;
            padding: 30px;
            animation: fadeIn 0.4s;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        h2 {
            color: #d4af37;
            margin-bottom: 25px;
            font-size: 1.5em;
            font-weight: 600;
        }
        
        h3 {
            color: #d4af37;
            margin: 25px 0 15px 0;
            font-size: 1.2em;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: #0f1620;
            padding: 25px;
            border-radius: 8px;
            border: 1px solid #2a3544;
            transition: all 0.3s;
        }
        
        .stat-card:hover {
            border-color: #d4af37;
            transform: translateY(-2px);
        }
        
        .stat-card h3 {
            font-size: 0.85em;
            color: #b0b0b0;
            margin: 0 0 10px 0;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .stat-card .value {
            font-size: 2.5em;
            font-weight: bold;
            color: #d4af37;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group label {
            margin-bottom: 8px;
            font-weight: 500;
            color: #d4af37;
            font-size: 0.9em;
        }
        
        .form-group input,
        .form-group select {
            padding: 12px;
            border: 1px solid #2a3544;
            border-radius: 6px;
            font-size: 0.95em;
            background: #0f1620;
            color: #e0e0e0;
            transition: border 0.3s;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #d4af37;
        }
        
        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 6px;
            font-size: 0.95em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #d4af37;
            color: #0a1929;
        }
        
        .btn-primary:hover {
            background: #f0c850;
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: #2a3544;
            color: #e0e0e0;
        }
        
        .btn-secondary:hover {
            background: #3a4554;
        }
        
        .btn-danger {
            background: #c62828;
            color: white;
        }
        
        .btn-danger:hover {
            background: #d32f2f;
        }
        
        .region-section {
            margin-bottom: 40px;
        }
        
        .region-title {
            background: #0f1620;
            color: #d4af37;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 1.1em;
            font-weight: 600;
            border: 1px solid #2a3544;
        }
        
        .time-grid {
            display: grid;
            grid-template-columns: 90px repeat(7, 1fr);
            gap: 4px;
            font-size: 0.85em;
        }
        
        .time-header, .day-header, .time-cell {
            padding: 10px 5px;
            text-align: center;
            border-radius: 4px;
        }
        
        .day-header {
            background: #0f1620;
            color: #d4af37;
            font-weight: 600;
            border: 1px solid #2a3544;
        }
        
        .time-header {
            background: #0f1620;
            font-weight: 500;
            color: #b0b0b0;
            border: 1px solid #2a3544;
        }
        
        .time-cell {
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 600;
            border: 1px solid #2a3544;
        }
        
        .time-cell.livre {
            background: #1b4332;
            color: #95d5b2;
        }
        
        .time-cell.livre:hover {
            background: #2d6a4f;
            border-color: #95d5b2;
        }
        
        .time-cell.ocupado {
            background: #3d1f1f;
            color: #e5989b;
        }
        
        .time-cell.ocupado:hover {
            background: #4d2f2f;
        }
        
        .agendamentos-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .agendamentos-table th,
        .agendamentos-table td {
            padding: 14px;
            text-align: left;
            border-bottom: 1px solid #2a3544;
        }
        
        .agendamentos-table th {
            background: #0f1620;
            color: #d4af37;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.85em;
            letter-spacing: 0.5px;
        }
        
        .agendamentos-table tr {
            background: #1a2332;
        }
        
        .agendamentos-table tr:hover {
            background: #0f1620;
        }
        
        .badge {
            padding: 5px 12px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: 500;
            display: inline-block;
        }
        
        .badge-diario {
            background: #1e3a5f;
            color: #64b5f6;
        }
        
        .badge-alternado {
            background: #4a3c1f;
            color: #d4af37;
        }
        
        .badge-uma-vez {
            background: #1b4332;
            color: #95d5b2;
        }
        
        .search-box {
            padding: 12px;
            border: 1px solid #2a3544;
            border-radius: 6px;
            font-size: 0.95em;
            width: 100%;
            margin-bottom: 20px;
            background: #0f1620;
            color: #e0e0e0;
        }
        
        .search-box:focus {
            outline: none;
            border-color: #d4af37;
        }
        
        .filter-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .filter-btn {
            padding: 10px 20px;
            border: 1px solid #2a3544;
            background: #0f1620;
            color: #b0b0b0;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9em;
        }
        
        .filter-btn:hover {
            border-color: #d4af37;
            color: #d4af37;
        }
        
        .filter-btn.active {
            background: #d4af37;
            color: #0a1929;
            border-color: #d4af37;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }
        
        .distribuicao-box {
            background: #0f1620;
            padding: 15px;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            border: 1px solid #2a3544;
        }
        
        .distribuicao-box:hover {
            border-color: #d4af37;
        }
        
        .distribuicao-box span:first-child {
            font-weight: 500;
            color: #e0e0e0;
        }
        
        .distribuicao-box span:nth-child(2) {
            font-size: 1.5em;
            color: #d4af37;
            font-weight: 600;
        }
        
        .distribuicao-box span:last-child {
            color: #b0b0b0;
        }
        
        .info-text {
            color: #b0b0b0;
            font-size: 0.9em;
            margin-bottom: 20px;
            padding: 12px;
            background: #0f1620;
            border-radius: 6px;
            border-left: 3px solid #d4af37;
        }
        
        .config-section {
            margin-top: 30px;
            padding: 25px;
            background: #0f1620;
            border-radius: 8px;
            border: 1px solid #2a3544;
        }
        
        .config-section h3 {
            margin-top: 0;
        }
        
        .config-section p {
            color: #b0b0b0;
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Sistema de Controle de Agendamentos</h1>
            <p>Gestão inteligente de postagens por região</p>
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="showTab('dashboard')">Dashboard</button>
            <button class="tab" onclick="showTab('cadastro')">Cadastrar</button>
            <button class="tab" onclick="showTab('disponibilidade')">Disponibilidade</button>
            <button class="tab" onclick="showTab('agendamentos')">Agendamentos</button>
            <button class="tab" onclick="showTab('historico')">Histórico</button>
            <button class="tab" onclick="showTab('analises')">Análises</button>
            <button class="tab" onclick="showTab('configuracoes')">Configurações</button>
        </div>
        
        <div id="dashboard" class="tab-content active">
            <h2>Dashboard Geral</h2>

            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Total de Agendamentos Ativos</h3>
                    <div class="value" id="totalAgendamentos">0</div>
                </div>
                <div class="stat-card">
                    <h3>Histórico Arquivado</h3>
                    <div class="value" id="totalHistorico">0</div>
                </div>
                <div class="stat-card">
                    <h3>Postagens Hoje</h3>
                    <div class="value" id="postagensHoje">0</div>
                </div>
                <div class="stat-card">
                    <h3>Total Geral</h3>
                    <div class="value" id="totalGeral">0</div>
                </div>
            </div>

            <h3 style="margin-top: 30px;">Resumo Financeiro</h3>
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Valor Médio por Alerta</h3>
                    <div class="value" style="font-size: 1.8em;" id="valorMedio">-</div>
                </div>
                <div class="stat-card">
                    <h3>Ticket Mais Alto</h3>
                    <div class="value" style="font-size: 1.8em;" id="ticketAlto">-</div>
                </div>
                <div class="stat-card">
                    <h3>Ticket Mais Baixo</h3>
                    <div class="value" style="font-size: 1.8em;" id="ticketBaixo">-</div>
                </div>
                <div class="stat-card">
                    <h3>Volume Total</h3>
                    <div class="value" style="font-size: 1.8em;" id="volumeTotal">-</div>
                </div>
            </div>

            <h3 style="margin-top: 30px;">Performance por Companhia</h3>
            <div id="performanceCompanhias"></div>

            <h3 style="margin-top: 30px;">Top 5 Rotas Mais Lucrativas</h3>
            <div id="topRotas"></div>

            <h3 style="margin-top: 30px;">Distribuição por Região</h3>
            <div id="distribuicaoRegioes"></div>

            <h3 style="margin-top: 30px;">Últimos 7 Dias</h3>
            <div id="ultimos7Dias"></div>
        </div>
        
        <div id="cadastro" class="tab-content">
            <h2 id="tituloCadastro">Cadastrar Novo Agendamento</h2>
            <form id="formCadastro" onsubmit="cadastrarAgendamento(event)">
                <input type="hidden" id="editandoIndex" value="">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Data</label>
                        <input type="date" id="data" required>
                    </div>
                    <div class="form-group">
                        <label>Horário</label>
                        <input type="time" id="horario" required>
                    </div>
                    <div class="form-group">
                        <label>Itinerário</label>
                        <input type="text" id="itinerario" placeholder="Ex: GRU - RIO" required>
                    </div>
                    <div class="form-group">
                        <label>Companhia Aérea</label>
                        <select id="companhia" required>
                            <option value="">Selecione...</option>
                            <option value="Azul">Azul</option>
                            <option value="Smiles">Smiles</option>
                            <option value="Latam">Latam</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Região</label>
                        <select id="regiao" required>
                            <option value="">Selecione...</option>
                            <option value="Norte">Norte</option>
                            <option value="Nordeste">Nordeste</option>
                            <option value="Centro-Oeste">Centro-Oeste</option>
                            <option value="Sudeste">Sudeste</option>
                            <option value="Sul">Sul</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Recorrência</label>
                        <select id="recorrencia" required>
                            <option value="Diário">Diário (todo dia)</option>
                            <option value="Dias Alternados">Dias Alternados</option>
                            <option value="Uma Vez">Uma Vez</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Link da Promoção</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="url" id="link" placeholder="https://..." style="flex: 1;">
                            <button type="button" class="btn btn-secondary" onclick="abrirLink()" style="white-space: nowrap;">Abrir Link</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Quantidade de Milhas</label>
                        <input type="text" id="milhas" placeholder="Ex: 15.000">
                    </div>
                    <div class="form-group">
                        <label>Valor do Milheiro (R$)</label>
                        <input type="text" id="valorMilheiro" placeholder="Ex: 31,00">
                    </div>
                    <div class="form-group">
                        <label>Taxas de Embarque (R$)</label>
                        <input type="text" id="taxas" placeholder="Ex: 250,00">
                    </div>
                    <div class="form-group">
                        <label>Anotações/Observações</label>
                        <input type="text" id="observacoes" placeholder="Ex: Melhor preço do mês, expira rápido...">
                    </div>
                </div>

                <div class="info-text" style="margin-top: 15px; margin-bottom: 15px;">
                    <strong>CUSTO TOTAL ESTIMADO:</strong> <span id="custoTotal" style="color: #d4af37; font-size: 1.2em; font-weight: bold;">-</span>
                </div>

                <div style="display: flex; gap: 10px;">
                    <button type="submit" class="btn btn-primary" id="btnSubmit">Cadastrar Agendamento</button>
                    <button type="button" class="btn btn-secondary" id="btnCancelar" onclick="cancelarEdicao()" style="display: none;">Cancelar Edição</button>
                </div>
            </form>
        </div>
        
        <div id="disponibilidade" class="tab-content">
            <h2>Disponibilidade por Região</h2>
            <div class="info-text">
                Verde = Livre | Vermelho = Ocupado | Clique em um horário livre para cadastrar
            </div>

            <div class="form-group" style="max-width: 300px; margin-bottom: 25px;">
                <label>Selecione a Região</label>
                <select id="regiaoFiltro" onchange="renderizarDisponibilidade()" style="font-size: 1.1em; padding: 14px;">
                    <option value="Todas">Todas as Regiões</option>
                    <option value="Norte">Norte</option>
                    <option value="Nordeste">Nordeste</option>
                    <option value="Centro-Oeste">Centro-Oeste</option>
                    <option value="Sudeste">Sudeste</option>
                    <option value="Sul">Sul</option>
                </select>
            </div>

            <div id="disponibilidadeContent"></div>
        </div>
        
        <div id="agendamentos" class="tab-content">
            <h2>Lista de Agendamentos</h2>
            <input type="text" class="search-box" id="searchBox" placeholder="Buscar por itinerário ou região..." onkeyup="filtrarAgendamentos()">
            
            <div class="filter-group">
                <button class="filter-btn active" onclick="filtrarPorRegiao('Todas')">Todas</button>
                <button class="filter-btn" onclick="filtrarPorRegiao('Norte')">Norte</button>
                <button class="filter-btn" onclick="filtrarPorRegiao('Nordeste')">Nordeste</button>
                <button class="filter-btn" onclick="filtrarPorRegiao('Centro-Oeste')">Centro-Oeste</button>
                <button class="filter-btn" onclick="filtrarPorRegiao('Sudeste')">Sudeste</button>
                <button class="filter-btn" onclick="filtrarPorRegiao('Sul')">Sul</button>
            </div>
            
            <div id="listaAgendamentos"></div>
        </div>

        <div id="historico" class="tab-content">
            <h2>Histórico de Agendamentos Arquivados</h2>

            <div class="info-text">
                Este é seu banco de dados histórico. Aqui ficam todos os agendamentos arquivados para análise futura.
            </div>

            <h3>Filtros e Relatórios</h3>
            <div class="form-grid" style="margin-bottom: 25px;">
                <div class="form-group">
                    <label>Período</label>
                    <select id="filtro_periodo" onchange="filtrarHistorico()">
                        <option value="todos">Todos os períodos</option>
                        <option value="30">Últimos 30 dias</option>
                        <option value="90">Últimos 3 meses</option>
                        <option value="180">Últimos 6 meses</option>
                        <option value="365">Último ano</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Itinerário</label>
                    <input type="text" id="filtro_itinerario" placeholder="Ex: GRU - RIO" onkeyup="filtrarHistorico()">
                </div>
                <div class="form-group">
                    <label>Companhia</label>
                    <select id="filtro_companhia" onchange="filtrarHistorico()">
                        <option value="todas">Todas</option>
                        <option value="Azul">Azul</option>
                        <option value="Smiles">Smiles</option>
                        <option value="Latam">Latam</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Região</label>
                    <select id="filtro_regiao_hist" onchange="filtrarHistorico()">
                        <option value="todas">Todas</option>
                        <option value="Norte">Norte</option>
                        <option value="Nordeste">Nordeste</option>
                        <option value="Centro-Oeste">Centro-Oeste</option>
                        <option value="Sudeste">Sudeste</option>
                        <option value="Sul">Sul</option>
                    </select>
                </div>
            </div>

            <div id="estatisticasHistorico"></div>

            <h3>Registros Arquivados</h3>
            <div id="listaHistorico"></div>
        </div>

        <div id="analises" class="tab-content">
            <h2>Análises e Insights</h2>

            <div class="info-text">
                Análises baseadas em todo o histórico de agendamentos (ativos + arquivados)
            </div>

            <h3>Comparador de Companhias Aéreas</h3>
            <div class="form-group" style="max-width: 400px; margin-bottom: 20px;">
                <label>Filtrar por Itinerário (opcional)</label>
                <input type="text" id="filtro_comparador" placeholder="Ex: GRU - RIO" onkeyup="atualizarComparador()">
            </div>
            <div id="comparadorCompanhias"></div>

            <h3 style="margin-top: 40px;">Análise de Sazonalidade</h3>
            <div class="form-group" style="max-width: 400px; margin-bottom: 20px;">
                <label>Selecione a Região</label>
                <select id="filtro_sazonalidade" onchange="atualizarSazonalidade()">
                    <option value="todas">Todas as Regiões</option>
                    <option value="Norte">Norte</option>
                    <option value="Nordeste">Nordeste</option>
                    <option value="Centro-Oeste">Centro-Oeste</option>
                    <option value="Sudeste">Sudeste</option>
                    <option value="Sul">Sul</option>
                </select>
            </div>
            <div id="sazonalidade"></div>
        </div>

        <div id="configuracoes" class="tab-content">
            <h2>Configurações e Dados</h2>
            <div style="display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap;">
                <button class="btn btn-primary" onclick="document.getElementById('fileImport').click()">Importar Dados (JSON)</button>
                <input type="file" id="fileImport" accept=".json" style="display: none;" onchange="importarDados(event)">
                <button class="btn btn-primary" onclick="exportarExcel()">Exportar Agendamentos (CSV)</button>
                <button class="btn btn-primary" onclick="exportarHistorico()">Exportar Histórico (CSV)</button>
                <button class="btn btn-secondary" onclick="backupDados()">Backup Completo</button>
                <button class="btn btn-danger" onclick="limparTodos()">Limpar Todos os Dados</button>
            </div>

            <div class="info-text" style="margin-top: 20px;">
                <strong>Como importar seus agendamentos:</strong><br>
                1. Clique em "Importar Dados (JSON)"<br>
                2. Selecione o arquivo "agendamentos_para_importar.json"<br>
                3. Os dados serão carregados automaticamente!
            </div>

            <div class="config-section">
                <h3>Sobre o Sistema</h3>
                <p>Sistema de Controle de Agendamentos - Versão 1.0</p>
                <p style="margin-top: 10px;">Os dados são salvos automaticamente no navegador (LocalStorage).</p>
                <p style="margin-top: 10px;">Para sincronizar entre dispositivos, utilize a função de Backup/Restaurar.</p>
            </div>
        </div>
    </div>

    <script>
        let agendamentos = [];
        let historico = [];
        let cotacaoMilha = 0.015; // Valor padrão

        function carregarDados() {
            const dadosSalvos = localStorage.getItem('agendamentos');
            if (dadosSalvos) {
                agendamentos = JSON.parse(dadosSalvos);
            } else {
                agendamentos = DADOS_INICIAIS;
                salvarDados();
            }

            const historicoSalvo = localStorage.getItem('historico');
            if (historicoSalvo) {
                historico = JSON.parse(historicoSalvo);
            }

            const cotacaoSalva = localStorage.getItem('cotacaoMilha');
            if (cotacaoSalva) {
                cotacaoMilha = parseFloat(cotacaoSalva);
                document.getElementById('cotacaoMilha').value = cotacaoMilha;
            }

            atualizarTudo();
        }

        function salvarDados() {
            localStorage.setItem('agendamentos', JSON.stringify(agendamentos));
            localStorage.setItem('historico', JSON.stringify(historico));
        }
        
        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
            
            if (tabName === 'disponibilidade') {
                renderizarDisponibilidade();
            } else if (tabName === 'agendamentos') {
                renderizarListaAgendamentos();
            } else if (tabName === 'historico') {
                filtrarHistorico();
            } else if (tabName === 'analises') {
                atualizarComparador();
                atualizarSazonalidade();
            }
        }
        
        function cadastrarAgendamento(e) {
            e.preventDefault();

            const data = document.getElementById('data').value;
            const horario = document.getElementById('horario').value;
            const itinerario = document.getElementById('itinerario').value;
            const companhia = document.getElementById('companhia').value;
            const regiao = document.getElementById('regiao').value;
            const recorrencia = document.getElementById('recorrencia').value;
            const link = document.getElementById('link').value;
            const milhas = document.getElementById('milhas').value;
            const valorMilheiro = document.getElementById('valorMilheiro').value;
            const taxas = document.getElementById('taxas').value;
            const observacoes = document.getElementById('observacoes').value;

            const dataObj = new Date(data + 'T00:00:00');
            const diasSemana = ['Domingo', 'Segunda', 'Terça', 'Quarta', 'Quinta', 'Sexta', 'Sábado'];
            const diaSemana = diasSemana[dataObj.getDay()];

            const editandoIndex = document.getElementById('editandoIndex').value;

            if (editandoIndex !== '') {
                // Modo edição - atualizar agendamento existente
                const index = parseInt(editandoIndex);
                const agendamentoOriginal = agendamentos[index];

                agendamentos[index] = {
                    data: formatarData(data),
                    dia_semana: diaSemana,
                    horario: horario,
                    itinerario: itinerario,
                    companhia: companhia,
                    regiao: regiao,
                    recorrencia: recorrencia,
                    link: link,
                    milhas: milhas,
                    valorMilheiro: valorMilheiro,
                    taxas: taxas,
                    observacoes: observacoes,
                    data_cadastro: agendamentoOriginal.data_cadastro,
                    hora_cadastro: agendamentoOriginal.hora_cadastro,
                    status: 'Agendado'
                };

                salvarDados();
                atualizarTudo();
                cancelarEdicao();
                alert('Agendamento atualizado com sucesso!');

            } else {
                // Modo cadastro - criar novo agendamento
                const agora = new Date();
                const dataCadastro = agora.toLocaleDateString('pt-BR');
                const horaCadastro = agora.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });

                agendamentos.push({
                    data: formatarData(data),
                    dia_semana: diaSemana,
                    horario: horario,
                    itinerario: itinerario,
                    companhia: companhia,
                    regiao: regiao,
                    recorrencia: recorrencia,
                    link: link,
                    milhas: milhas,
                    valorMilheiro: valorMilheiro,
                    taxas: taxas,
                    observacoes: observacoes,
                    data_cadastro: dataCadastro,
                    hora_cadastro: horaCadastro,
                    status: 'Agendado'
                });

                salvarDados();
                atualizarTudo();
                document.getElementById('formCadastro').reset();
                alert('Agendamento cadastrado com sucesso!');
            }
        }

        function editarAgendamento(index) {
            const ag = agendamentos[index];

            // Converter data de DD/MM/YYYY para YYYY-MM-DD
            const [dia, mes, ano] = ag.data.split('/');
            const dataFormatada = `${ano}-${mes}-${dia}`;

            // Preencher formulário
            document.getElementById('data').value = dataFormatada;
            document.getElementById('horario').value = ag.horario;
            document.getElementById('itinerario').value = ag.itinerario;
            document.getElementById('companhia').value = ag.companhia || '';
            document.getElementById('regiao').value = ag.regiao;
            document.getElementById('recorrencia').value = ag.recorrencia;
            document.getElementById('link').value = ag.link || '';
            document.getElementById('milhas').value = ag.milhas || '';
            document.getElementById('valorMilheiro').value = ag.valorMilheiro || '';
            document.getElementById('taxas').value = ag.taxas || '';
            document.getElementById('observacoes').value = ag.observacoes || '';

            // Calcular custo total
            calcularCustoTotal();

            // Marcar como editando
            document.getElementById('editandoIndex').value = index;
            document.getElementById('tituloCadastro').textContent = 'Editar Agendamento';
            document.getElementById('btnSubmit').textContent = 'Salvar Alterações';
            document.getElementById('btnCancelar').style.display = 'block';

            // Ir para aba de cadastro
            document.querySelector('.tab:nth-child(2)').click();

            // Scroll para o topo
            window.scrollTo(0, 0);
        }

        function cancelarEdicao() {
            document.getElementById('formCadastro').reset();
            document.getElementById('editandoIndex').value = '';
            document.getElementById('tituloCadastro').textContent = 'Cadastrar Novo Agendamento';
            document.getElementById('btnSubmit').textContent = 'Cadastrar Agendamento';
            document.getElementById('btnCancelar').style.display = 'none';
        }
        
        function formatarData(data) {
            const [ano, mes, dia] = data.split('-');
            return `${dia}/${mes}/${ano}`;
        }

        function abrirLink() {
            const link = document.getElementById('link').value.trim();
            if (link) {
                if (link.startsWith('http://') || link.startsWith('https://')) {
                    window.open(link, '_blank');
                } else {
                    alert('Por favor, insira um link válido começando com http:// ou https://');
                }
            } else {
                alert('Por favor, preencha o campo de link primeiro!');
            }
        }
        
        function atualizarTudo() {
            atualizarDashboard();
            if (document.getElementById('disponibilidade').classList.contains('active')) {
                renderizarDisponibilidade();
            }
            if (document.getElementById('agendamentos').classList.contains('active')) {
                renderizarListaAgendamentos();
            }
        }
        
        function atualizarDashboard() {
            // Estatísticas básicas
            document.getElementById('totalAgendamentos').textContent = agendamentos.length;
            document.getElementById('totalHistorico').textContent = historico.length;
            document.getElementById('totalGeral').textContent = agendamentos.length + historico.length;

            const hoje = new Date().toLocaleDateString('pt-BR');
            const postagensHoje = agendamentos.filter(a => a.data === hoje).length;
            document.getElementById('postagensHoje').textContent = postagensHoje;

            // Combinar dados ativos e histórico para análises
            const todosDados = [...agendamentos, ...historico];

            // Calcular valores (apenas com dados completos)
            const dadosComValor = todosDados.filter(d => d.milhas && d.valorMilheiro);
            const valores = dadosComValor.map(d => {
                const milhasNum = parseFloat(d.milhas.replace(/[^\d]/g, ''));
                const valorMilheiroNum = parseFloat(d.valorMilheiro.replace(/[^\d,]/g, '').replace(',', '.'));
                const taxasNum = d.taxas ? parseFloat(d.taxas.replace(/[^\d,]/g, '').replace(',', '.')) : 0;
                return (milhasNum / 1000) * valorMilheiroNum + taxasNum;
            });

            if (valores.length > 0) {
                const soma = valores.reduce((a, b) => a + b, 0);
                const valorMedio = soma / valores.length;
                const ticketAlto = Math.max(...valores);
                const ticketBaixo = Math.min(...valores);

                document.getElementById('valorMedio').textContent = 'R$ ' + valorMedio.toFixed(2).replace('.', ',');
                document.getElementById('ticketAlto').textContent = 'R$ ' + ticketAlto.toFixed(2).replace('.', ',');
                document.getElementById('ticketBaixo').textContent = 'R$ ' + ticketBaixo.toFixed(2).replace('.', ',');
                document.getElementById('volumeTotal').textContent = 'R$ ' + soma.toFixed(2).replace('.', ',');
            } else {
                document.getElementById('valorMedio').textContent = '-';
                document.getElementById('ticketAlto').textContent = '-';
                document.getElementById('ticketBaixo').textContent = '-';
                document.getElementById('volumeTotal').textContent = '-';
            }

            // Performance por Companhia
            const companhias = ['Azul', 'Smiles', 'Latam'];
            let htmlComp = '<div class="stats-grid">';

            companhias.forEach(cia => {
                const dados = dadosComValor.filter(d => d.companhia === cia);
                if (dados.length > 0) {
                    const valoresCia = dados.map(d => {
                        const milhasNum = parseFloat(d.milhas.replace(/[^\d]/g, ''));
                        const valorMilheiroNum = parseFloat(d.valorMilheiro.replace(/[^\d,]/g, '').replace(',', '.'));
                        const taxasNum = d.taxas ? parseFloat(d.taxas.replace(/[^\d,]/g, '').replace(',', '.')) : 0;
                        return (milhasNum / 1000) * valorMilheiroNum + taxasNum;
                    });
                    const mediaCia = valoresCia.reduce((a, b) => a + b, 0) / valoresCia.length;

                    htmlComp += `
                        <div class="stat-card">
                            <h3>${cia}</h3>
                            <div class="value" style="font-size: 1.5em;">R$ ${mediaCia.toFixed(2).replace('.', ',')}</div>
                            <p style="color: #b0b0b0; font-size: 0.9em; margin-top: 10px;">${dados.length} alertas</p>
                        </div>
                    `;
                }
            });

            htmlComp += '</div>';
            document.getElementById('performanceCompanhias').innerHTML = htmlComp;

            // Top 5 Rotas
            const rotasValor = {};
            dadosComValor.forEach(d => {
                const milhasNum = parseFloat(d.milhas.replace(/[^\d]/g, ''));
                const valorMilheiroNum = parseFloat(d.valorMilheiro.replace(/[^\d,]/g, '').replace(',', '.'));
                const taxasNum = d.taxas ? parseFloat(d.taxas.replace(/[^\d,]/g, '').replace(',', '.')) : 0;
                const valor = (milhasNum / 1000) * valorMilheiroNum + taxasNum;

                if (!rotasValor[d.itinerario]) {
                    rotasValor[d.itinerario] = { total: 0, count: 0 };
                }
                rotasValor[d.itinerario].total += valor;
                rotasValor[d.itinerario].count++;
            });

            const topRotas = Object.entries(rotasValor)
                .map(([rota, data]) => ({ rota, media: data.total / data.count, count: data.count }))
                .sort((a, b) => b.media - a.media)
                .slice(0, 5);

            let htmlRotas = '';
            topRotas.forEach(item => {
                htmlRotas += `
                    <div class="distribuicao-box">
                        <span>${item.rota}</span>
                        <span style="color: #d4af37;">R$ ${item.media.toFixed(2).replace('.', ',')}</span>
                        <span>${item.count} alertas</span>
                    </div>
                `;
            });
            document.getElementById('topRotas').innerHTML = htmlRotas || '<p style="color: #b0b0b0;">Nenhuma rota cadastrada ainda</p>';

            // Distribuição por Região
            const regioes = ['Norte', 'Nordeste', 'Centro-Oeste', 'Sudeste', 'Sul'];
            let htmlReg = '';

            regioes.forEach(regiao => {
                const count = agendamentos.filter(a => a.regiao === regiao).length;
                const percent = agendamentos.length > 0 ? (count / agendamentos.length * 100).toFixed(1) : 0;
                htmlReg += `
                    <div class="distribuicao-box">
                        <span>${regiao}</span>
                        <span>${count}</span>
                        <span>${percent}%</span>
                    </div>
                `;
            });

            document.getElementById('distribuicaoRegioes').innerHTML = htmlReg;

            // Últimos 7 dias
            const ultimos7 = [];
            const dataHoje = new Date();

            for (let i = 6; i >= 0; i--) {
                const data = new Date(dataHoje);
                data.setDate(dataHoje.getDate() - i);
                const dataStr = data.toLocaleDateString('pt-BR');

                const cadastrosNoDia = todosDados.filter(d => d.data_cadastro === dataStr).length;

                ultimos7.push({ data: dataStr, count: cadastrosNoDia });
            }

            let html7Dias = '';
            ultimos7.forEach(item => {
                const larguraBarra = ultimos7.length > 0 ? (item.count / Math.max(...ultimos7.map(x => x.count), 1) * 100) : 0;

                html7Dias += `
                    <div class="distribuicao-box" style="position: relative; overflow: hidden;">
                        <div style="position: absolute; left: 0; top: 0; bottom: 0; width: ${larguraBarra}%; background: rgba(212, 175, 55, 0.15); z-index: 0;"></div>
                        <span style="position: relative; z-index: 1;">${item.data}</span>
                        <span style="position: relative; z-index: 1;">${item.count}</span>
                        <span style="position: relative; z-index: 1;">alertas</span>
                    </div>
                `;
            });

            document.getElementById('ultimos7Dias').innerHTML = html7Dias;
        }
        
        function renderizarDisponibilidade() {
            let regioesFiltradas = ['Norte', 'Nordeste', 'Centro-Oeste', 'Sudeste', 'Sul'];

            const regiaoSelecionada = document.getElementById('regiaoFiltro')?.value || 'Todas';

            if (regiaoSelecionada !== 'Todas') {
                regioesFiltradas = [regiaoSelecionada];
            }

            const horarios = ['08:00', '08:30', '09:00', '09:30', '10:00', '10:30', '11:00', '11:30',
                              '12:00', '12:30', '13:00', '13:30', '14:00', '14:30', '15:00', '15:30',
                              '16:00', '16:30', '17:00', '17:30', '18:00', '18:30', '19:00', '19:30',
                              '20:00', '20:30', '21:00'];

            const dataInicio = new Date('2026-01-21');
            const dias = [];
            for (let i = 0; i < 7; i++) {
                const data = new Date(dataInicio);
                data.setDate(dataInicio.getDate() + i);
                dias.push(data);
            }

            let html = '';

            regioesFiltradas.forEach(regiao => {
                html += `<div class="region-section">`;
                html += `<div class="region-title">REGIÃO: ${regiao.toUpperCase()}</div>`;
                html += `<div class="time-grid">`;
                
                html += `<div class="time-header">Horário</div>`;
                dias.forEach(dia => {
                    const nomeDia = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'][dia.getDay()];
                    html += `<div class="day-header">${nomeDia}<br>${dia.getDate()}/${(dia.getMonth()+1).toString().padStart(2,'0')}</div>`;
                });
                
                horarios.forEach(horario => {
                    html += `<div class="time-header">${horario}</div>`;
                    
                    dias.forEach(dia => {
                        const ocupado = verificarOcupado(regiao, horario, dia);
                        const classe = ocupado ? 'ocupado' : 'livre';
                        const texto = ocupado ? 'X' : 'OK';
                        html += `<div class="time-cell ${classe}" onclick="selecionarHorario('${regiao}', '${horario}', '${dia.toISOString().split('T')[0]}')">${texto}</div>`;
                    });
                });
                
                html += `</div></div>`;
            });
            
            document.getElementById('disponibilidadeContent').innerHTML = html;
        }
        
        function verificarOcupado(regiao, horario, dia) {
            return agendamentos.some(ag => {
                if (ag.regiao !== regiao || ag.horario !== horario) return false;
                
                const dataAg = parseData(ag.data);
                const recorrencia = ag.recorrencia || 'Diário';
                
                if (recorrencia === 'Diário') {
                    return dia >= dataAg;
                } else if (recorrencia === 'Dias Alternados') {
                    const diffDias = Math.floor((dia - dataAg) / (1000 * 60 * 60 * 24));
                    return diffDias >= 0 && diffDias % 2 === 0;
                } else {
                    return dia.toDateString() === dataAg.toDateString();
                }
            });
        }
        
        function parseData(dataStr) {
            const [dia, mes, ano] = dataStr.split('/');
            return new Date(ano, mes - 1, dia);
        }
        
        function selecionarHorario(regiao, horario, data) {
            document.getElementById('regiao').value = regiao;
            document.getElementById('horario').value = horario;
            document.getElementById('data').value = data;
            document.querySelector('.tab:nth-child(2)').click();
        }
        
        let filtroRegiaoAtual = 'Todas';
        
        function renderizarListaAgendamentos() {
            let agendamentosFiltrados = agendamentos;
            
            if (filtroRegiaoAtual !== 'Todas') {
                agendamentosFiltrados = agendamentos.filter(a => a.regiao === filtroRegiaoAtual);
            }
            
            const busca = document.getElementById('searchBox')?.value.toLowerCase() || '';
            if (busca) {
                agendamentosFiltrados = agendamentosFiltrados.filter(a => 
                    a.itinerario.toLowerCase().includes(busca) ||
                    a.regiao.toLowerCase().includes(busca)
                );
            }
            
            if (agendamentosFiltrados.length === 0) {
                document.getElementById('listaAgendamentos').innerHTML = `
                    <div class="empty-state">
                        <h3>Nenhum agendamento encontrado</h3>
                        <p>Tente ajustar os filtros ou adicionar novos agendamentos</p>
                    </div>
                `;
                return;
            }
            
            let html = '<table class="agendamentos-table"><thead><tr>';
            html += '<th>Data Agend.</th><th>Dia</th><th>Horário</th><th>Itinerário</th><th>Cia Aérea</th><th>Região</th><th>Recorrência</th><th>Milhas</th><th>R$/Milheiro</th><th>Taxas</th><th>Custo Total</th><th>Observações</th><th>Cadastrado em</th><th>Link</th><th>Ações</th>';
            html += '</tr></thead><tbody>';

            agendamentosFiltrados.forEach((ag, index) => {
                const badgeClass = ag.recorrencia === 'Diário' ? 'badge-diario' :
                                   ag.recorrencia === 'Dias Alternados' ? 'badge-alternado' : 'badge-uma-vez';
                const realIndex = agendamentos.indexOf(ag);
                const linkBtn = ag.link ? `<button class="btn btn-secondary" style="padding: 6px 12px; font-size: 0.8em;" onclick="window.open('${ag.link}', '_blank')">Abrir</button>` : '-';
                const milhasTexto = ag.milhas || '-';
                const valorMilheiroTexto = ag.valorMilheiro ? 'R$ ' + ag.valorMilheiro : '-';
                const taxasTexto = ag.taxas || '-';
                const companhiaTexto = ag.companhia || '-';
                const obsTexto = ag.observacoes || '-';
                const cadastroTexto = ag.data_cadastro && ag.hora_cadastro ? `${ag.data_cadastro}<br>${ag.hora_cadastro}` : '-';

                // Calcular custo total
                let custoTotalTexto = '-';
                if (ag.milhas && ag.valorMilheiro) {
                    const milhasNum = parseFloat(ag.milhas.replace(/[^\d]/g, ''));
                    const valorMilheiroNum = parseFloat(ag.valorMilheiro.replace(/[^\d,]/g, '').replace(',', '.'));
                    const taxasNum = ag.taxas ? parseFloat(ag.taxas.replace(/[^\d,]/g, '').replace(',', '.')) : 0;
                    const custoMilhas = (milhasNum / 1000) * valorMilheiroNum;
                    const total = custoMilhas + taxasNum;
                    custoTotalTexto = 'R$ ' + total.toFixed(2).replace('.', ',');
                }
                html += `<tr>
                    <td>${ag.data}</td>
                    <td>${ag.dia_semana}</td>
                    <td>${ag.horario}</td>
                    <td>${ag.itinerario}</td>
                    <td>${companhiaTexto}</td>
                    <td>${ag.regiao}</td>
                    <td><span class="badge ${badgeClass}">${ag.recorrencia}</span></td>
                    <td>${milhasTexto}</td>
                    <td>${valorMilheiroTexto}</td>
                    <td>${taxasTexto}</td>
                    <td style="font-weight: bold; color: #d4af37;">${custoTotalTexto}</td>
                    <td style="font-size: 0.85em; max-width: 200px;">${obsTexto}</td>
                    <td style="font-size: 0.85em;">${cadastroTexto}</td>
                    <td>${linkBtn}</td>
                    <td>
                        <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                            <button class="btn btn-primary" style="padding: 6px 12px; font-size: 0.8em;" onclick='gerarPostRedeSocial(${JSON.stringify(ag).replace(/'/g, "\\'")})'>Gerar Post</button>
                            <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 0.8em;" onclick="editarAgendamento(${realIndex})">Editar</button>
                            <button class="btn btn-danger" style="padding: 6px 12px; font-size: 0.8em;" onclick="excluirAgendamento(${realIndex})">Arquivar</button>
                        </div>
                    </td>
                </tr>`;
            });
            
            html += '</tbody></table>';
            document.getElementById('listaAgendamentos').innerHTML = html;
        }
        
        function filtrarPorRegiao(regiao) {
            filtroRegiaoAtual = regiao;
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            renderizarListaAgendamentos();
        }
        
        function filtrarAgendamentos() {
            renderizarListaAgendamentos();
        }
        
        function excluirAgendamento(index) {
            if (confirm('Deseja arquivar este agendamento? Ele será movido para o Histórico.')) {
                const agendamento = agendamentos[index];

                // Adicionar data de arquivamento
                const agora = new Date();
                agendamento.data_arquivamento = agora.toLocaleDateString('pt-BR');
                agendamento.hora_arquivamento = agora.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });

                // Mover para histórico
                historico.push(agendamento);

                // Remover dos agendamentos ativos
                agendamentos.splice(index, 1);

                salvarDados();
                atualizarTudo();
                alert('Agendamento arquivado com sucesso! Veja na aba Histórico.');
            }
        }
        
        function exportarExcel() {
            let csv = 'Data Agendamento,Dia Semana,Horário,Itinerário,Companhia,Região,Recorrência,Milhas,Valor Milheiro,Taxas,Observações,Data Cadastro,Hora Cadastro,Link,Status\n';
            agendamentos.forEach(ag => {
                csv += `${ag.data},${ag.dia_semana},${ag.horario},${ag.itinerario},"${ag.companhia || ''}",${ag.regiao},${ag.recorrencia},"${ag.milhas || ''}","${ag.valorMilheiro || ''}","${ag.taxas || ''}","${ag.observacoes || ''}","${ag.data_cadastro || ''}","${ag.hora_cadastro || ''}","${ag.link || ''}",${ag.status}\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'agendamentos_' + new Date().toISOString().split('T')[0] + '.csv';
            link.click();
            alert('Arquivo Excel exportado com sucesso!');
        }
        
        function backupDados() {
            const backup = {
                agendamentos: agendamentos,
                historico: historico,
                data_backup: new Date().toLocaleString('pt-BR')
            };
            const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'backup_completo_' + new Date().toISOString().split('T')[0] + '.json';
            link.click();
            alert('Backup completo realizado com sucesso!');
        }

        function exportarHistorico() {
            if (historico.length === 0) {
                alert('Não há dados no histórico para exportar!');
                return;
            }

            let csv = 'Data Agendamento,Dia Semana,Horário,Itinerário,Companhia,Região,Recorrência,Milhas,Valor Milheiro,Taxas,Observações,Data Cadastro,Hora Cadastro,Data Arquivamento,Hora Arquivamento,Link\n';
            historico.forEach(ag => {
                csv += `${ag.data},${ag.dia_semana},${ag.horario},${ag.itinerario},"${ag.companhia || ''}",${ag.regiao},${ag.recorrencia},"${ag.milhas || ''}","${ag.valorMilheiro || ''}","${ag.taxas || ''}","${ag.observacoes || ''}","${ag.data_cadastro || ''}","${ag.hora_cadastro || ''}","${ag.data_arquivamento || ''}","${ag.hora_arquivamento || ''}","${ag.link || ''}"\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'historico_' + new Date().toISOString().split('T')[0] + '.csv';
            link.click();
            alert('Histórico exportado com sucesso!');
        }
        
        function importarDados(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const dadosImportados = JSON.parse(e.target.result);

                    if (!Array.isArray(dadosImportados)) {
                        alert('Erro: O arquivo não contém um formato válido!');
                        return;
                    }

                    if (agendamentos.length > 0) {
                        if (confirm(`Você já tem ${agendamentos.length} agendamentos. Deseja SUBSTITUIR todos pelos dados importados?`)) {
                            agendamentos = dadosImportados;
                        } else if (confirm('Deseja ADICIONAR os dados importados aos existentes?')) {
                            agendamentos = agendamentos.concat(dadosImportados);
                        } else {
                            return;
                        }
                    } else {
                        agendamentos = dadosImportados;
                    }

                    salvarDados();
                    atualizarTudo();
                    alert(`Sucesso! ${dadosImportados.length} agendamentos importados!`);

                } catch (error) {
                    alert('Erro ao importar arquivo: ' + error.message);
                }
            };
            reader.readAsText(file);

            // Limpar input para permitir reimportação
            event.target.value = '';
        }

        function limparTodos() {
            if (confirm('ATENÇÃO! Isso vai apagar TODOS os agendamentos. Tem certeza?')) {
                if (confirm('Última confirmação! Deseja realmente excluir TUDO?')) {
                    agendamentos = [];
                    salvarDados();
                    atualizarTudo();
                    alert('Todos os dados foram limpos!');
                }
            }
        }

        // ===== FUNÇÕES DO HISTÓRICO =====

        function filtrarHistorico() {
            const periodo = document.getElementById('filtro_periodo')?.value || 'todos';
            const itinerario = document.getElementById('filtro_itinerario')?.value.toLowerCase() || '';
            const companhia = document.getElementById('filtro_companhia')?.value || 'todas';
            const regiao = document.getElementById('filtro_regiao_hist')?.value || 'todas';

            let historicoFiltrado = [...historico];

            // Filtrar por período
            if (periodo !== 'todos') {
                const diasAtras = parseInt(periodo);
                const dataLimite = new Date();
                dataLimite.setDate(dataLimite.getDate() - diasAtras);

                historicoFiltrado = historicoFiltrado.filter(h => {
                    const dataArq = parseData(h.data_arquivamento);
                    return dataArq >= dataLimite;
                });
            }

            // Filtrar por itinerário
            if (itinerario) {
                historicoFiltrado = historicoFiltrado.filter(h =>
                    h.itinerario.toLowerCase().includes(itinerario)
                );
            }

            // Filtrar por companhia
            if (companhia !== 'todas') {
                historicoFiltrado = historicoFiltrado.filter(h => h.companhia === companhia);
            }

            // Filtrar por região
            if (regiao !== 'todas') {
                historicoFiltrado = historicoFiltrado.filter(h => h.regiao === regiao);
            }

            renderizarEstatisticas(historicoFiltrado);
            renderizarListaHistorico(historicoFiltrado);
        }

        function renderizarEstatisticas(dados) {
            if (dados.length === 0) {
                document.getElementById('estatisticasHistorico').innerHTML = '';
                return;
            }

            // Calcular estatísticas
            const totalRegistros = dados.length;

            // Média de milhas
            const dadosComMilhas = dados.filter(d => d.milhas && d.milhas.trim() !== '');
            let mediaMilhas = 0;
            if (dadosComMilhas.length > 0) {
                const somaMilhas = dadosComMilhas.reduce((acc, d) => {
                    const valor = parseFloat(d.milhas.replace(/[^\d]/g, ''));
                    return acc + (isNaN(valor) ? 0 : valor);
                }, 0);
                mediaMilhas = Math.round(somaMilhas / dadosComMilhas.length);
            }

            // Média de taxas
            const dadosComTaxas = dados.filter(d => d.taxas && d.taxas.trim() !== '');
            let mediaTaxas = 0;
            if (dadosComTaxas.length > 0) {
                const somaTaxas = dadosComTaxas.reduce((acc, d) => {
                    const valor = parseFloat(d.taxas.replace(/[^\d,]/g, '').replace(',', '.'));
                    return acc + (isNaN(valor) ? 0 : valor);
                }, 0);
                mediaTaxas = (somaTaxas / dadosComTaxas.length).toFixed(2);
            }

            // Rotas mais frequentes
            const rotas = {};
            dados.forEach(d => {
                rotas[d.itinerario] = (rotas[d.itinerario] || 0) + 1;
            });
            const rotasOrdenadas = Object.entries(rotas)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);

            let html = '<div class="stats-grid" style="margin-bottom: 30px;">';
            html += `
                <div class="stat-card">
                    <h3>Total de Registros</h3>
                    <div class="value">${totalRegistros}</div>
                </div>
                <div class="stat-card">
                    <h3>Média de Milhas</h3>
                    <div class="value">${mediaMilhas > 0 ? mediaMilhas.toLocaleString('pt-BR') : '-'}</div>
                </div>
                <div class="stat-card">
                    <h3>Média de Taxas</h3>
                    <div class="value">${mediaTaxas > 0 ? 'R$ ' + mediaTaxas : '-'}</div>
                </div>
            `;
            html += '</div>';

            if (rotasOrdenadas.length > 0) {
                html += '<h3>Top 5 Rotas Mais Frequentes</h3>';
                rotasOrdenadas.forEach(([rota, qtd]) => {
                    html += `
                        <div class="distribuicao-box">
                            <span>${rota}</span>
                            <span>${qtd}</span>
                            <span>${((qtd / totalRegistros) * 100).toFixed(1)}%</span>
                        </div>
                    `;
                });
            }

            document.getElementById('estatisticasHistorico').innerHTML = html;
        }

        function renderizarListaHistorico(dados) {
            if (dados.length === 0) {
                document.getElementById('listaHistorico').innerHTML = `
                    <div class="empty-state">
                        <h3>Nenhum registro encontrado</h3>
                        <p>Ajuste os filtros ou aguarde até arquivar agendamentos</p>
                    </div>
                `;
                return;
            }

            let html = '<table class="agendamentos-table"><thead><tr>';
            html += '<th>Data Agend.</th><th>Itinerário</th><th>Cia Aérea</th><th>Região</th><th>Milhas</th><th>Taxas</th><th>Arquivado em</th><th>Ações</th>';
            html += '</tr></thead><tbody>';

            dados.forEach((ag, index) => {
                const milhasTexto = ag.milhas || '-';
                const taxasTexto = ag.taxas || '-';
                const companhiaTexto = ag.companhia || '-';
                const arquivadoTexto = ag.data_arquivamento && ag.hora_arquivamento ? `${ag.data_arquivamento}<br>${ag.hora_arquivamento}` : '-';
                const linkBtn = ag.link ? `<button class="btn btn-secondary" style="padding: 6px 12px; font-size: 0.8em;" onclick="window.open('${ag.link}', '_blank')">Abrir</button>` : '-';

                const realIndex = historico.indexOf(ag);

                html += `<tr>
                    <td>${ag.data}</td>
                    <td>${ag.itinerario}</td>
                    <td>${companhiaTexto}</td>
                    <td>${ag.regiao}</td>
                    <td>${milhasTexto}</td>
                    <td>${taxasTexto}</td>
                    <td style="font-size: 0.85em;">${arquivadoTexto}</td>
                    <td>
                        <div style="display: flex; gap: 5px;">
                            ${linkBtn}
                            <button class="btn btn-primary" style="padding: 6px 12px; font-size: 0.8em;" onclick="restaurarAgendamento(${realIndex})">Restaurar</button>
                        </div>
                    </td>
                </tr>`;
            });

            html += '</tbody></table>';
            document.getElementById('listaHistorico').innerHTML = html;
        }

        function restaurarAgendamento(index) {
            if (confirm('Deseja restaurar este agendamento para a lista ativa?')) {
                const agendamento = historico[index];

                // Remover campos de arquivamento
                delete agendamento.data_arquivamento;
                delete agendamento.hora_arquivamento;

                // Adicionar de volta aos agendamentos ativos
                agendamentos.push(agendamento);

                // Remover do histórico
                historico.splice(index, 1);

                salvarDados();
                atualizarTudo();
                filtrarHistorico();

                alert('Agendamento restaurado com sucesso!');
            }
        }

        // ===== CALCULADORA DE CUSTO TOTAL =====

        function calcularCustoTotal() {
            const milhasInput = document.getElementById('milhas').value;
            const valorMilheiroInput = document.getElementById('valorMilheiro').value;
            const taxasInput = document.getElementById('taxas').value;

            if (!milhasInput && !taxasInput) {
                document.getElementById('custoTotal').textContent = '-';
                return;
            }

            // Extrair número de milhas
            const milhasNum = parseFloat(milhasInput.replace(/[^\d]/g, ''));

            // Extrair valor do milheiro
            const valorMilheiroNum = parseFloat(valorMilheiroInput.replace(/[^\d,]/g, '').replace(',', '.'));

            // Calcular custo das milhas: (milhas / 1000) × valor do milheiro
            const custoMilhas = (!isNaN(milhasNum) && !isNaN(valorMilheiroNum)) ? (milhasNum / 1000) * valorMilheiroNum : 0;

            // Extrair valor das taxas
            const taxasNum = parseFloat(taxasInput.replace(/[^\d,]/g, '').replace(',', '.'));
            const custoTaxas = isNaN(taxasNum) ? 0 : taxasNum;

            const total = custoMilhas + custoTaxas;

            if (total > 0) {
                const detalhes = [];
                if (custoMilhas > 0) {
                    detalhes.push(`${milhasNum.toLocaleString('pt-BR')} milhas × R$ ${valorMilheiroNum.toFixed(2)} = R$ ${custoMilhas.toFixed(2)}`);
                }
                if (custoTaxas > 0) {
                    detalhes.push(`Taxas: R$ ${custoTaxas.toFixed(2)}`);
                }

                document.getElementById('custoTotal').textContent =
                    `R$ ${total.toFixed(2).replace('.', ',')} (${detalhes.join(' + ')})`;
            } else {
                document.getElementById('custoTotal').textContent = '-';
            }
        }

        function salvarCotacao() {
            const valor = parseFloat(document.getElementById('cotacaoMilha').value);
            if (!isNaN(valor) && valor > 0) {
                cotacaoMilha = valor;
                localStorage.setItem('cotacaoMilha', cotacaoMilha);
                calcularCustoTotal();
                alert('Cotação salva com sucesso!');
            }
        }

        // Event listeners para calcular em tempo real
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('milhas')?.addEventListener('input', calcularCustoTotal);
            document.getElementById('valorMilheiro')?.addEventListener('input', calcularCustoTotal);
            document.getElementById('taxas')?.addEventListener('input', calcularCustoTotal);
        });

        // ===== COMPARADOR DE COMPANHIAS =====

        function atualizarComparador() {
            const filtroItinerario = document.getElementById('filtro_comparador')?.value.toLowerCase() || '';

            // Combinar ativos e histórico
            const todosDados = [...agendamentos, ...historico];

            let dadosFiltrados = todosDados;
            if (filtroItinerario) {
                dadosFiltrados = todosDados.filter(d => d.itinerario.toLowerCase().includes(filtroItinerario));
            }

            const companhias = ['Azul', 'Smiles', 'Latam'];
            const estatisticas = {};

            companhias.forEach(cia => {
                const dados = dadosFiltrados.filter(d => d.companhia === cia);

                if (dados.length === 0) {
                    estatisticas[cia] = null;
                    return;
                }

                // Média de milhas
                const dadosComMilhas = dados.filter(d => d.milhas && d.milhas.trim() !== '');
                let mediaMilhas = 0;
                if (dadosComMilhas.length > 0) {
                    const soma = dadosComMilhas.reduce((acc, d) => {
                        const valor = parseFloat(d.milhas.replace(/[^\d]/g, ''));
                        return acc + (isNaN(valor) ? 0 : valor);
                    }, 0);
                    mediaMilhas = Math.round(soma / dadosComMilhas.length);
                }

                // Média de taxas
                const dadosComTaxas = dados.filter(d => d.taxas && d.taxas.trim() !== '');
                let mediaTaxas = 0;
                if (dadosComTaxas.length > 0) {
                    const soma = dadosComTaxas.reduce((acc, d) => {
                        const valor = parseFloat(d.taxas.replace(/[^\d,]/g, '').replace(',', '.'));
                        return acc + (isNaN(valor) ? 0 : valor);
                    }, 0);
                    mediaTaxas = soma / dadosComTaxas.length;
                }

                const custoTotal = (mediaMilhas * cotacaoMilha) + mediaTaxas;

                estatisticas[cia] = {
                    total: dados.length,
                    mediaMilhas: mediaMilhas,
                    mediaTaxas: mediaTaxas,
                    custoTotal: custoTotal
                };
            });

            let html = '';

            if (Object.values(estatisticas).every(e => e === null)) {
                html = '<div class="empty-state"><h3>Nenhum dado disponível</h3><p>Cadastre agendamentos para ver as estatísticas</p></div>';
            } else {
                html += '<div class="stats-grid">';

                companhias.forEach(cia => {
                    const stats = estatisticas[cia];
                    if (!stats) {
                        html += `
                            <div class="stat-card" style="opacity: 0.5;">
                                <h3>${cia}</h3>
                                <div class="value" style="font-size: 1.5em;">Sem dados</div>
                            </div>
                        `;
                        return;
                    }

                    html += `
                        <div class="stat-card">
                            <h3>${cia}</h3>
                            <div class="value" style="font-size: 1.3em; margin-bottom: 10px;">R$ ${stats.custoTotal.toFixed(2)}</div>
                            <p style="color: #b0b0b0; font-size: 0.85em; margin: 5px 0;">
                                <strong>Milhas:</strong> ${stats.mediaMilhas.toLocaleString('pt-BR')}<br>
                                <strong>Taxas:</strong> R$ ${stats.mediaTaxas.toFixed(2)}<br>
                                <strong>Registros:</strong> ${stats.total}
                            </p>
                        </div>
                    `;
                });

                html += '</div>';

                // Encontrar melhor opção
                const validos = Object.entries(estatisticas).filter(([_, v]) => v !== null);
                if (validos.length > 0) {
                    const melhor = validos.reduce((min, [cia, stats]) =>
                        stats.custoTotal < min.stats.custoTotal ? {cia, stats} : min
                    , {cia: validos[0][0], stats: validos[0][1]});

                    html += `
                        <div class="info-text" style="margin-top: 20px;">
                            <strong>*** Melhor Custo-Benefício:</strong> ${melhor.cia} com custo médio de R$ ${melhor.stats.custoTotal.toFixed(2)}
                        </div>
                    `;
                }
            }

            document.getElementById('comparadorCompanhias').innerHTML = html;
        }

        // ===== ANÁLISE DE SAZONALIDADE =====

        function atualizarSazonalidade() {
            const regiaoFiltro = document.getElementById('filtro_sazonalidade')?.value || 'todas';

            const todosDados = [...agendamentos, ...historico];
            let dadosFiltrados = todosDados;

            if (regiaoFiltro !== 'todas') {
                dadosFiltrados = todosDados.filter(d => d.regiao === regiaoFiltro);
            }

            // Agrupar por mês
            const meses = {
                '01': 'Janeiro', '02': 'Fevereiro', '03': 'Março', '04': 'Abril',
                '05': 'Maio', '06': 'Junho', '07': 'Julho', '08': 'Agosto',
                '09': 'Setembro', '10': 'Outubro', '11': 'Novembro', '12': 'Dezembro'
            };

            const porMes = {};
            Object.keys(meses).forEach(m => porMes[m] = 0);

            dadosFiltrados.forEach(d => {
                if (d.data_cadastro) {
                    const [dia, mes, ano] = d.data_cadastro.split('/');
                    if (mes && porMes[mes] !== undefined) {
                        porMes[mes]++;
                    }
                }
            });

            const total = Object.values(porMes).reduce((a, b) => a + b, 0);

            let html = '';

            if (total === 0) {
                html = '<div class="empty-state"><h3>Nenhum dado disponível</h3><p>Aguarde até ter histórico com datas de cadastro</p></div>';
            } else {
                html += '<p style="color: #b0b0b0; margin-bottom: 20px;">Quantidade de promoções cadastradas por mês</p>';

                Object.entries(porMes).forEach(([mes, qtd]) => {
                    const percent = total > 0 ? (qtd / total * 100).toFixed(1) : 0;
                    const larguraBarra = total > 0 ? (qtd / total * 100) : 0;

                    html += `
                        <div class="distribuicao-box" style="position: relative; overflow: hidden;">
                            <div style="position: absolute; left: 0; top: 0; bottom: 0; width: ${larguraBarra}%; background: rgba(212, 175, 55, 0.15); z-index: 0;"></div>
                            <span style="position: relative; z-index: 1;">${meses[mes]}</span>
                            <span style="position: relative; z-index: 1;">${qtd}</span>
                            <span style="position: relative; z-index: 1;">${percent}%</span>
                        </div>
                    `;
                });

                // Destacar melhor mês
                const melhorMes = Object.entries(porMes).reduce((max, [mes, qtd]) =>
                    qtd > max.qtd ? {mes, qtd} : max
                , {mes: '01', qtd: 0});

                if (melhorMes.qtd > 0) {
                    html += `
                        <div class="info-text" style="margin-top: 20px;">
                            <strong>*** Mês com Mais Promoções:</strong> ${meses[melhorMes.mes]} com ${melhorMes.qtd} registros (${(melhorMes.qtd / total * 100).toFixed(1)}%)
                        </div>
                    `;
                }
            }

            document.getElementById('sazonalidade').innerHTML = html;
        }

        // ===== EXPORTAR PARA REDES SOCIAIS =====

        function gerarPostRedeSocial(agendamento) {
            const itinerario = agendamento.itinerario;
            const companhia = agendamento.companhia || '';

            // Calcular valor em REAL (não mostrar milhas)
            let valorReal = 'Consultar';
            if (agendamento.milhas && agendamento.valorMilheiro) {
                const milhasNum = parseFloat(agendamento.milhas.replace(/[^\d]/g, ''));
                const valorMilheiroNum = parseFloat(agendamento.valorMilheiro.replace(/[^\d,]/g, '').replace(',', '.'));
                const taxasNum = agendamento.taxas ? parseFloat(agendamento.taxas.replace(/[^\d,]/g, '').replace(',', '.')) : 0;
                const custoMilhas = (milhasNum / 1000) * valorMilheiroNum;
                const total = custoMilhas + taxasNum;
                valorReal = 'R$ ' + total.toFixed(2).replace('.', ',');
            }

            const post = `🔥 ALERTA DE PASSAGEM 🔥

✈️ ${itinerario}
💰 ${valorReal}
${companhia ? '🏢 ' + companhia : ''}

⚠️ Poucas tarifas disponíveis!

${agendamento.link || ''}`;

            // Copiar para clipboard
            navigator.clipboard.writeText(post).then(() => {
                alert('Post copiado para área de transferência!\n\nCole agora no WhatsApp, Instagram ou Telegram!');
            }).catch(() => {
                // Fallback: mostrar em alert
                alert('Post gerado:\n\n' + post);
            });
        }

        const DADOS_INICIAIS =

        carregarDados();
    </script>
</body>
</html>
