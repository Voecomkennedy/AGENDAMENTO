<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Controle de Agendamentos</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.2/jspdf.umd.min.js" integrity="sha512-Bw9Zj8x4giJb3OmlMiMaGbNrFr0ERD2f9jL3en5FmcTXLhkI+fKyXVeyGyxKMIl1RfgcCBDprJJt4JvlglEb3A==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0a1929;
            min-height: 100vh;
            padding: 20px;
            color: #e0e0e0;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: #1a2332;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
            overflow: hidden;
            border: 1px solid #2a3544;
        }
        
        .header {
            background: linear-gradient(135deg, #0a1929 0%, #1a2332 100%);
            color: #d4af37;
            padding: 30px;
            border-bottom: 2px solid #d4af37;
        }
        
        .header h1 {
            font-size: 2em;
            margin-bottom: 5px;
            font-weight: 600;
            letter-spacing: 1px;
        }
        
        .header p {
            color: #b0b0b0;
            font-size: 0.95em;
        }
        
        .tabs {
            display: flex;
            background: #0f1620;
            border-bottom: 1px solid #2a3544;
        }
        
        .tab {
            flex: 1;
            padding: 18px;
            text-align: center;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
            border: none;
            background: none;
            font-size: 0.95em;
            color: #b0b0b0;
            border-bottom: 3px solid transparent;
        }
        
        .tab:hover {
            background: #1a2332;
            color: #d4af37;
        }
        
        .tab.active {
            background: #1a2332;
            color: #d4af37;
            border-bottom: 3px solid #d4af37;
        }
        
        .tab-content {
            display: none;
            padding: 30px;
            animation: fadeIn 0.4s;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        h2 {
            color: #d4af37;
            margin-bottom: 25px;
            font-size: 1.5em;
            font-weight: 600;
        }
        
        h3 {
            color: #d4af37;
            margin: 25px 0 15px 0;
            font-size: 1.2em;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: #0f1620;
            padding: 25px;
            border-radius: 8px;
            border: 1px solid #2a3544;
            transition: all 0.3s;
        }
        
        .stat-card:hover {
            border-color: #d4af37;
            transform: translateY(-2px);
        }
        
        .stat-card h3 {
            font-size: 0.85em;
            color: #b0b0b0;
            margin: 0 0 10px 0;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .stat-card .value {
            font-size: 2.5em;
            font-weight: bold;
            color: #d4af37;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group label {
            margin-bottom: 8px;
            font-weight: 500;
            color: #d4af37;
            font-size: 0.9em;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 12px;
            border: 1px solid #2a3544;
            border-radius: 6px;
            font-size: 0.95em;
            background: #0f1620;
            color: #e0e0e0;
            transition: border 0.3s;
            font-family: inherit;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
            line-height: 1.5;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #d4af37;
        }
        
        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 6px;
            font-size: 0.95em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #d4af37;
            color: #0a1929;
        }
        
        .btn-primary:hover {
            background: #f0c850;
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: #2a3544;
            color: #e0e0e0;
        }
        
        .btn-secondary:hover {
            background: #3a4554;
        }
        
        .btn-danger {
            background: #c62828;
            color: white;
        }
        
        .btn-danger:hover {
            background: #d32f2f;
        }
        
        .region-section {
            margin-bottom: 40px;
        }
        
        .region-title {
            background: #0f1620;
            color: #d4af37;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 1.1em;
            font-weight: 600;
            border: 1px solid #2a3544;
        }
        
        .time-grid {
            display: grid;
            grid-template-columns: 90px repeat(7, 1fr);
            gap: 4px;
            font-size: 0.85em;
        }
        
        .time-header, .day-header, .time-cell {
            padding: 10px 5px;
            text-align: center;
            border-radius: 4px;
        }
        
        .day-header {
            background: #0f1620;
            color: #d4af37;
            font-weight: 600;
            border: 1px solid #2a3544;
        }
        
        .time-header {
            background: #0f1620;
            font-weight: 500;
            color: #b0b0b0;
            border: 1px solid #2a3544;
        }
        
        .time-cell {
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 600;
            border: 1px solid #2a3544;
        }
        
        .time-cell.livre {
            background: #1b4332;
            color: #95d5b2;
        }
        
        .time-cell.livre:hover {
            background: #2d6a4f;
            border-color: #95d5b2;
        }
        
        .time-cell.ocupado {
            background: #3d1f1f;
            color: #e5989b;
        }
        
        .time-cell.ocupado:hover {
            background: #4d2f2f;
        }
        
        .agendamentos-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .agendamentos-table th,
        .agendamentos-table td {
            padding: 14px;
            text-align: left;
            border-bottom: 1px solid #2a3544;
        }
        
        .agendamentos-table th {
            background: #0f1620;
            color: #d4af37;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.85em;
            letter-spacing: 0.5px;
        }
        
        .agendamentos-table tr {
            background: #1a2332;
        }
        
        .agendamentos-table tr:hover {
            background: #0f1620;
        }
        
        .badge {
            padding: 5px 12px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: 500;
            display: inline-block;
        }
        
        .badge-diario {
            background: #1e3a5f;
            color: #64b5f6;
        }
        
        .badge-alternado {
            background: #4a3c1f;
            color: #d4af37;
        }
        
        .badge-uma-vez {
            background: #1b4332;
            color: #95d5b2;
        }
        
        .search-box {
            padding: 12px;
            border: 1px solid #2a3544;
            border-radius: 6px;
            font-size: 0.95em;
            width: 100%;
            margin-bottom: 20px;
            background: #0f1620;
            color: #e0e0e0;
        }
        
        .search-box:focus {
            outline: none;
            border-color: #d4af37;
        }
        
        .filter-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .filter-btn {
            padding: 10px 20px;
            border: 1px solid #2a3544;
            background: #0f1620;
            color: #b0b0b0;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9em;
        }
        
        .filter-btn:hover {
            border-color: #d4af37;
            color: #d4af37;
        }
        
        .filter-btn.active {
            background: #d4af37;
            color: #0a1929;
            border-color: #d4af37;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }
        
        .distribuicao-box {
            background: #0f1620;
            padding: 15px;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            border: 1px solid #2a3544;
        }
        
        .distribuicao-box:hover {
            border-color: #d4af37;
        }
        
        .distribuicao-box span:first-child {
            font-weight: 500;
            color: #e0e0e0;
        }
        
        .distribuicao-box span:nth-child(2) {
            font-size: 1.5em;
            color: #d4af37;
            font-weight: 600;
        }
        
        .distribuicao-box span:last-child {
            color: #b0b0b0;
        }
        
        .info-text {
            color: #b0b0b0;
            font-size: 0.9em;
            margin-bottom: 20px;
            padding: 12px;
            background: #0f1620;
            border-radius: 6px;
            border-left: 3px solid #d4af37;
        }
        
        .config-section {
            margin-top: 30px;
            padding: 25px;
            background: #0f1620;
            border-radius: 8px;
            border: 1px solid #2a3544;
        }
        
        .config-section h3 {
            margin-top: 0;
        }
        
        .config-section p {
            color: #b0b0b0;
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Sistema de Controle de Agendamentos</h1>
            <p>Gestão inteligente de postagens por região</p>
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="showTab('dashboard')">Dashboard</button>
            <button class="tab" onclick="showTab('cadastro')">Cadastrar</button>
            <button class="tab" onclick="showTab('agendamentos')">Agendamentos</button>
            <button class="tab" onclick="showTab('historico')">Histórico</button>
            <button class="tab" onclick="showTab('cotacoes')">Cotações</button>
            <button class="tab" onclick="showTab('analises')">Análises</button>
            <button class="tab" onclick="showTab('configuracoes')">Configurações</button>
        </div>
        
        <div id="dashboard" class="tab-content active">
            <h2>Dashboard Geral</h2>

            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Total de Agendamentos Ativos</h3>
                    <div class="value" id="totalAgendamentos">0</div>
                </div>
                <div class="stat-card">
                    <h3>Histórico Arquivado</h3>
                    <div class="value" id="totalHistorico">0</div>
                </div>
                <div class="stat-card">
                    <h3>Postagens Hoje</h3>
                    <div class="value" id="postagensHoje">0</div>
                </div>
                <div class="stat-card">
                    <h3>Total Geral</h3>
                    <div class="value" id="totalGeral">0</div>
                </div>
            </div>

            <h3 style="margin-top: 30px;">Resumo Financeiro</h3>
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Valor Médio por Alerta</h3>
                    <div class="value" style="font-size: 1.8em;" id="valorMedio">-</div>
                </div>
                <div class="stat-card">
                    <h3>Ticket Mais Alto</h3>
                    <div class="value" style="font-size: 1.8em;" id="ticketAlto">-</div>
                </div>
                <div class="stat-card">
                    <h3>Ticket Mais Baixo</h3>
                    <div class="value" style="font-size: 1.8em;" id="ticketBaixo">-</div>
                </div>
                <div class="stat-card">
                    <h3>Volume Total</h3>
                    <div class="value" style="font-size: 1.8em;" id="volumeTotal">-</div>
                </div>
            </div>

            <h3 style="margin-top: 30px;">Performance por Companhia</h3>
            <div id="performanceCompanhias"></div>

            <h3 style="margin-top: 30px;">Top 5 Rotas Mais Lucrativas</h3>
            <div id="topRotas"></div>

            <h3 style="margin-top: 30px;">Distribuição por Região</h3>
            <div id="distribuicaoRegioes"></div>

            <h3 style="margin-top: 30px;">Últimos 7 Dias</h3>
            <div id="ultimos7Dias"></div>
        </div>
        
        <div id="cadastro" class="tab-content">
            <h2 id="tituloCadastro">Cadastrar Novo Agendamento</h2>
            <form id="formCadastro" onsubmit="cadastrarAgendamento(event)">
                <input type="hidden" id="editandoIndex" value="">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Data de Início</label>
                        <input type="date" id="data" required>
                    </div>
                    <div class="form-group">
                        <label>Região</label>
                        <select id="regiao" required onchange="atualizarHorariosDisponiveis()">
                            <option value="">Selecione a região primeiro...</option>
                            <option value="Norte">Norte</option>
                            <option value="Nordeste">Nordeste</option>
                            <option value="Centro-Oeste">Centro-Oeste</option>
                            <option value="Sudeste">Sudeste</option>
                            <option value="Sul">Sul</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Horário</label>
                        <select id="horario" required>
                            <option value="">Selecione a região primeiro</option>
                        </select>
                        <small style="color: #888; display: block; margin-top: 5px;">Apenas horários disponíveis são mostrados</small>
                    </div>
                    <div class="form-group">
                        <label>Itinerário</label>
                        <input type="text" id="itinerario" placeholder="Ex: GRU - RIO" required>
                    </div>
                    <div class="form-group">
                        <label>Companhia Aérea</label>
                        <select id="companhia" required>
                            <option value="">Selecione...</option>
                            <option value="Azul">Azul</option>
                            <option value="Smiles">Smiles</option>
                            <option value="Latam">Latam</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Frequência</label>
                        <select id="recorrencia" required onchange="toggleFrequenciaPersonalizada()">
                            <option value="Diário">Diário (todo dia)</option>
                            <option value="Personalizado">Personalizado (a cada X dias)</option>
                            <option value="Uma Vez">Uma Vez (não repete)</option>
                        </select>
                    </div>
                    <div class="form-group" id="campoFrequenciaPersonalizada" style="display: none;">
                        <label>A cada quantos dias?</label>
                        <select id="diasIntervalo">
                            <option value="2">A cada 2 dias</option>
                            <option value="3">A cada 3 dias</option>
                            <option value="4">A cada 4 dias</option>
                            <option value="5">A cada 5 dias</option>
                            <option value="6">A cada 6 dias</option>
                            <option value="7">A cada 7 dias (semanal)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Data de Término (quando parar de postar)</label>
                        <input type="date" id="dataTermino">
                        <small style="color: #888; display: block; margin-top: 5px;">Deixe em branco para não ter data fim</small>
                    </div>
                    <div class="form-group">
                        <label>Link da Companhia Aérea (link original da promoção)</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="url" id="linkCompanhia" placeholder="https://..." style="flex: 1;">
                            <button type="button" class="btn btn-secondary" onclick="abrirLinkCompanhia()" style="white-space: nowrap;">Abrir Link</button>
                        </div>
                        <small style="color: #888; display: block; margin-top: 5px;">Link direto da companhia aérea (Latam, GOL, Azul, etc)</small>
                    </div>

                    <!-- Grid responsivo para Milhas e Valores -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px;">
                        <div class="form-group">
                            <label>Quantidade de Milhas</label>
                            <input type="text" id="milhas" placeholder="Ex: 15.000">
                        </div>
                        <div class="form-group">
                            <label>Valor do Milheiro (R$)</label>
                            <input type="text" id="valorMilheiro" placeholder="Ex: 31,00">
                        </div>
                        <div class="form-group">
                            <label>Taxas de Embarque (R$)</label>
                            <input type="text" id="taxas" placeholder="Ex: 250,00">
                        </div>
                        <div class="form-group">
                            <label>Preço Médio de Mercado (R$)</label>
                            <div style="display: flex; gap: 10px;">
                                <input type="text" id="precoMedio" placeholder="Ex: 850,00" style="flex: 1;">
                                <button type="button" class="btn btn-secondary" onclick="calcularPrecoMedio()" style="white-space: nowrap;">Calcular Auto</button>
                            </div>
                            <small style="color: #888; display: block; margin-top: 5px;">Auto: +40% nacional, +30% internacional</small>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Anotações/Observações</label>
                        <input type="text" id="observacoes" placeholder="Ex: Melhor preço do mês, expira rápido...">
                    </div>

                    <!-- Grid responsivo para Datas IDA e VOLTA -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">
                        <div class="form-group">
                            <label>Datas de IDA</label>
                            <textarea id="datasIda" rows="6" placeholder="Fev: 21, 22, 24, 25, 26&#10;Mar: 14, 18, 26, 31&#10;Abr: 19&#10;Mai: 08, 17"></textarea>
                            <small style="color: #888; display: block; margin-top: 5px;">Cole as datas de ida por mês. Formato: Mês: dia, dia, dia</small>
                        </div>
                        <div class="form-group">
                            <label>Datas de VOLTA</label>
                            <textarea id="datasVolta" rows="6" placeholder="Fev: 22, 23, 25, 26, 28&#10;Mar: 02, 09, 26, 31&#10;Abr: 07, 10, 23&#10;Mai: 08, 15, 22, 23, 28"></textarea>
                            <small style="color: #888; display: block; margin-top: 5px;">Cole as datas de volta por mês. Formato: Mês: dia, dia, dia</small>
                        </div>
                    </div>
                </div>

                <div class="info-text" style="margin-top: 15px; margin-bottom: 15px;">
                    <strong>CUSTO TOTAL (PIX):</strong> <span id="custoTotal" style="color: #d4af37; font-size: 1.2em; font-weight: bold;">-</span><br>
                    <strong>PREÇO CARTÃO (5x):</strong> <span id="precoCartao" style="color: #d4af37; font-size: 1.2em; font-weight: bold;">-</span>
                </div>

                <div class="form-group" style="margin-top: 15px;">
                    <label>Link Gerado para Emissão (Cópia Automática)</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="linkGerado" readonly placeholder="O link aparecerá aqui..." style="background: #15202b; color: #90caf9; border-color: #1e3a5f; flex: 1;">
                        <button type="button" class="btn btn-secondary" onclick="window.open(document.getElementById('linkGerado').value, '_blank')" style="white-space: nowrap;">Testar Link</button>
                    </div>
                </div>

                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button type="button" class="btn" onclick="gerarPostCompleto()" style="background: linear-gradient(135deg, #d4af37 0%, #f4d03f 100%); color: #0a1929; font-weight: bold; flex: 1; min-width: 250px;">Gerar Post Completo VoeComKennedy</button>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 10px;">
                    <button type="submit" class="btn btn-primary" id="btnSubmit">Cadastrar Agendamento</button>
                    <button type="button" class="btn btn-secondary" id="btnCancelar" onclick="cancelarEdicao()" style="display: none;">Cancelar Edição</button>
                </div>
            </form>
        </div>
        
        <div id="disponibilidade" class="tab-content">
            <h2>Disponibilidade por Região</h2>
            <div class="info-text">
                Verde = Livre | Vermelho = Ocupado | Clique em um horário livre para cadastrar
            </div>

            <div class="form-group" style="max-width: 300px; margin-bottom: 25px;">
                <label>Selecione a Região</label>
                <select id="regiaoFiltro" onchange="renderizarDisponibilidade()" style="font-size: 1.1em; padding: 14px;">
                    <option value="Todas">Todas as Regiões</option>
                    <option value="Norte">Norte</option>
                    <option value="Nordeste">Nordeste</option>
                    <option value="Centro-Oeste">Centro-Oeste</option>
                    <option value="Sudeste">Sudeste</option>
                    <option value="Sul">Sul</option>
                </select>
            </div>

            <div id="disponibilidadeContent"></div>
        </div>
        
        <div id="agendamentos" class="tab-content">
            <h2>Lista de Agendamentos</h2>
            <input type="text" class="search-box" id="searchBox" placeholder="Buscar por itinerário ou região..." onkeyup="filtrarAgendamentos()">
            
            <div class="filter-group">
                <button class="filter-btn active" onclick="filtrarPorRegiao('Todas')">Todas</button>
                <button class="filter-btn" onclick="filtrarPorRegiao('Norte')">Norte</button>
                <button class="filter-btn" onclick="filtrarPorRegiao('Nordeste')">Nordeste</button>
                <button class="filter-btn" onclick="filtrarPorRegiao('Centro-Oeste')">Centro-Oeste</button>
                <button class="filter-btn" onclick="filtrarPorRegiao('Sudeste')">Sudeste</button>
                <button class="filter-btn" onclick="filtrarPorRegiao('Sul')">Sul</button>
            </div>
            
            <div id="listaAgendamentos"></div>
        </div>

        <div id="historico" class="tab-content">
            <h2>Histórico de Agendamentos Arquivados</h2>

            <div class="info-text">
                Este é seu banco de dados histórico. Aqui ficam todos os agendamentos arquivados para análise futura.
            </div>

            <h3>Filtros e Relatórios</h3>
            <div class="form-grid" style="margin-bottom: 25px;">
                <div class="form-group">
                    <label>Período</label>
                    <select id="filtro_periodo" onchange="filtrarHistorico()">
                        <option value="todos">Todos os períodos</option>
                        <option value="30">Últimos 30 dias</option>
                        <option value="90">Últimos 3 meses</option>
                        <option value="180">Últimos 6 meses</option>
                        <option value="365">Último ano</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Itinerário</label>
                    <input type="text" id="filtro_itinerario" placeholder="Ex: GRU - RIO" onkeyup="filtrarHistorico()">
                </div>
                <div class="form-group">
                    <label>Companhia</label>
                    <select id="filtro_companhia" onchange="filtrarHistorico()">
                        <option value="todas">Todas</option>
                        <option value="Azul">Azul</option>
                        <option value="Smiles">Smiles</option>
                        <option value="Latam">Latam</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Região</label>
                    <select id="filtro_regiao_hist" onchange="filtrarHistorico()">
                        <option value="todas">Todas</option>
                        <option value="Norte">Norte</option>
                        <option value="Nordeste">Nordeste</option>
                        <option value="Centro-Oeste">Centro-Oeste</option>
                        <option value="Sudeste">Sudeste</option>
                        <option value="Sul">Sul</option>
                    </select>
                </div>
            </div>

            <div id="estatisticasHistorico"></div>

            <h3>Registros Arquivados</h3>
            <div id="listaHistorico"></div>
        </div>

        <div id="cotacoes" class="tab-content">
            <h2>Cotações de Viagens</h2>

            <div class="info-text">
                Crie orçamentos profissionais para seus clientes. Gere PDF ou copie para WhatsApp!
            </div>

            <form id="formCotacao" style="margin-top: 25px;">
                <input type="hidden" id="editandoCotacaoIndex" value="">

                <h3>Dados do Cliente</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">
                    <div class="form-group">
                        <label>Nome do Cliente</label>
                        <input type="text" id="cotacao_nomeCliente" placeholder="Ex: João Silva" required>
                    </div>
                </div>

                <h3>Passageiros</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div class="form-group">
                        <label>Adultos (12+ anos)</label>
                        <select id="cotacao_adultos" onchange="atualizarTotalPassageiros()">
                            <option value="1">1 adulto</option>
                            <option value="2">2 adultos</option>
                            <option value="3">3 adultos</option>
                            <option value="4">4 adultos</option>
                            <option value="5">5 adultos</option>
                            <option value="6">6 adultos</option>
                            <option value="7">7 adultos</option>
                            <option value="8">8 adultos</option>
                            <option value="9">9 adultos</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Crianças (2-11 anos)</label>
                        <select id="cotacao_criancas" onchange="atualizarTotalPassageiros()">
                            <option value="0">Nenhuma</option>
                            <option value="1">1 criança</option>
                            <option value="2">2 crianças</option>
                            <option value="3">3 crianças</option>
                            <option value="4">4 crianças</option>
                            <option value="5">5 crianças</option>
                            <option value="6">6 crianças</option>
                            <option value="7">7 crianças</option>
                            <option value="8">8 crianças</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Bebês (0-23 meses)</label>
                        <select id="cotacao_bebes" onchange="atualizarTotalPassageiros()">
                            <option value="0">Nenhum</option>
                            <option value="1">1 bebê</option>
                            <option value="2">2 bebês</option>
                            <option value="3">3 bebês</option>
                            <option value="4">4 bebês</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Total de Passageiros</label>
                        <input type="text" id="cotacao_numPassageiros" value="1 adulto" readonly style="background: #1a2942; color: #d4af37; font-weight: bold;">
                    </div>
                </div>

                <h3>Detalhes do Voo</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px;">
                    <div class="form-group">
                        <label>Origem (Digite código IATA ou cidade)</label>
                        <input type="text" id="cotacao_origem" placeholder="Ex: GRU ou São Paulo" required onblur="autoCompletarAeroporto('cotacao_origem')">
                        <small style="color: #888; display: block; margin-top: 3px;">Digite código (GRU, CGH, etc) e tecle fora do campo</small>
                    </div>
                    <div class="form-group">
                        <label>Destino (Digite código IATA ou cidade)</label>
                        <input type="text" id="cotacao_destino" placeholder="Ex: BCN ou Barcelona" required onblur="autoCompletarAeroporto('cotacao_destino')">
                        <small style="color: #888; display: block; margin-top: 3px;">Digite código (BCN, LIS, etc) e tecle fora do campo</small>
                    </div>
                    <div class="form-group">
                        <label>Companhia Aérea</label>
                        <select id="cotacao_companhia" required onchange="atualizarInfoCalculoMilhas()">
                            <option value="">Selecione...</option>
                            <option value="LATAM">LATAM</option>
                            <option value="GOL">GOL (Smiles)</option>
                            <option value="Azul">Azul</option>
                            <option value="Outra">Outra</option>
                        </select>
                        <small id="infoCalculoMilhas" style="color: #d4af37; display: block; margin-top: 5px; font-weight: bold;"></small>
                    </div>
                    <div class="form-group">
                        <label>Tipo de Tarifa</label>
                        <select id="cotacao_tipoTarifa" onchange="preencherBagagem()">
                            <option value="">Selecione...</option>
                            <option value="Básica">Básica</option>
                            <option value="Light">Light</option>
                            <option value="Standard">Standard</option>
                            <option value="Plus">Plus</option>
                            <option value="Executiva">Executiva</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label>Link da Companhia Aérea</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="url" id="cotacao_linkCompanhia" placeholder="https://..." style="flex: 1;">
                        <button type="button" class="btn btn-secondary" onclick="window.open(document.getElementById('cotacao_linkCompanhia').value, '_blank')" style="white-space: nowrap;">Abrir Link</button>
                    </div>
                    <small style="color: #888; display: block; margin-top: 5px;">Salve o link para consultar depois</small>
                </div>

                <div class="form-group">
                    <label>Tipo de Viagem</label>
                    <select id="cotacao_tipoViagem" onchange="toggleVolta()">
                        <option value="ida-volta">Ida e Volta</option>
                        <option value="somente-ida">Somente Ida</option>
                    </select>
                </div>

                <h3>Voo de IDA</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div class="form-group">
                        <label>Data IDA</label>
                        <input type="date" id="cotacao_dataIda" required>
                    </div>
                    <div class="form-group">
                        <label>Horário Saída</label>
                        <input type="time" id="cotacao_horaSaidaIda" required onchange="calcularTempoVooIda()">
                    </div>
                    <div class="form-group">
                        <label>Horário Chegada</label>
                        <input type="time" id="cotacao_horaChegadaIda" required onchange="calcularTempoVooIda()">
                    </div>
                    <div class="form-group">
                        <label>Tempo Total de Voo</label>
                        <input type="text" id="cotacao_tempoVooIda" placeholder="Ex: 8h 30min" style="background: #1a2942; color: #d4af37; font-weight: bold;">
                    </div>
                    <div class="form-group">
                        <label>Tem Conexão?</label>
                        <select id="cotacao_conexaoIda" onchange="toggleConexaoIda()">
                            <option value="nao">Voo Direto</option>
                            <option value="sim">Sim, tem conexão</option>
                        </select>
                    </div>
                </div>

                <div id="detalhesConexaoIda" style="display: none; margin-top: 10px;">
                    <div class="form-group">
                        <label>Quantas Paradas?</label>
                        <select id="cotacao_numParadasIda" onchange="mostrarParadasIda()">
                            <option value="1">1 parada</option>
                            <option value="2">2 paradas</option>
                            <option value="3">3 paradas</option>
                        </select>
                    </div>

                    <div id="parada1Ida" style="margin-top: 10px;">
                        <h4 style="color: #d4af37; font-size: 0.9em; margin-bottom: 10px;">Parada 1</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                            <div class="form-group">
                                <label>Cidade</label>
                                <input type="text" id="cotacao_parada1CidadeIda" placeholder="Ex: Brasília" onblur="autoCompletarAeroporto('cotacao_parada1CidadeIda')">
                            </div>
                            <div class="form-group">
                                <label>Tempo de Espera</label>
                                <input type="text" id="cotacao_parada1TempoIda" placeholder="Ex: 2h 30min">
                            </div>
                        </div>
                    </div>

                    <div id="parada2Ida" style="display: none; margin-top: 10px;">
                        <h4 style="color: #d4af37; font-size: 0.9em; margin-bottom: 10px;">Parada 2</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                            <div class="form-group">
                                <label>Cidade</label>
                                <input type="text" id="cotacao_parada2CidadeIda" placeholder="Ex: Miami" onblur="autoCompletarAeroporto('cotacao_parada2CidadeIda')">
                            </div>
                            <div class="form-group">
                                <label>Tempo de Espera</label>
                                <input type="text" id="cotacao_parada2TempoIda" placeholder="Ex: 1h 45min">
                            </div>
                        </div>
                    </div>

                    <div id="parada3Ida" style="display: none; margin-top: 10px;">
                        <h4 style="color: #d4af37; font-size: 0.9em; margin-bottom: 10px;">Parada 3</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                            <div class="form-group">
                                <label>Cidade</label>
                                <input type="text" id="cotacao_parada3CidadeIda" placeholder="Ex: Lisboa" onblur="autoCompletarAeroporto('cotacao_parada3CidadeIda')">
                            </div>
                            <div class="form-group">
                                <label>Tempo de Espera</label>
                                <input type="text" id="cotacao_parada3TempoIda" placeholder="Ex: 3h">
                            </div>
                        </div>
                    </div>
                </div>

                <div id="secaoVolta">
                    <h3>Voo de VOLTA</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div class="form-group">
                            <label>Data VOLTA</label>
                            <input type="date" id="cotacao_dataVolta">
                    </div>
                    <div class="form-group">
                        <label>Horário Saída</label>
                        <input type="time" id="cotacao_horaSaidaVolta" onchange="calcularTempoVooVolta()">
                    </div>
                    <div class="form-group">
                        <label>Horário Chegada</label>
                        <input type="time" id="cotacao_horaChegadaVolta" onchange="calcularTempoVooVolta()">
                    </div>
                    <div class="form-group">
                        <label>Tempo Total de Voo</label>
                        <input type="text" id="cotacao_tempoVooVolta" placeholder="Ex: 8h 30min" style="background: #1a2942; color: #d4af37; font-weight: bold;">
                    </div>
                    <div class="form-group">
                        <label>Tem Conexão?</label>
                        <select id="cotacao_conexaoVolta" onchange="toggleConexaoVolta()">
                            <option value="nao">Voo Direto</option>
                            <option value="sim">Sim, tem conexão</option>
                        </select>
                    </div>
                </div>

                    <div id="detalhesConexaoVolta" style="display: none; margin-top: 10px;">
                        <div class="form-group">
                            <label>Quantas Paradas?</label>
                            <select id="cotacao_numParadasVolta" onchange="mostrarParadasVolta()">
                                <option value="1">1 parada</option>
                                <option value="2">2 paradas</option>
                                <option value="3">3 paradas</option>
                            </select>
                        </div>

                        <div id="parada1Volta" style="margin-top: 10px;">
                            <h4 style="color: #d4af37; font-size: 0.9em; margin-bottom: 10px;">Parada 1</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                                <div class="form-group">
                                    <label>Cidade</label>
                                    <input type="text" id="cotacao_parada1CidadeVolta" placeholder="Ex: Brasília" onblur="autoCompletarAeroporto('cotacao_parada1CidadeVolta')">
                                </div>
                                <div class="form-group">
                                    <label>Tempo de Espera</label>
                                    <input type="text" id="cotacao_parada1TempoVolta" placeholder="Ex: 2h 30min">
                                </div>
                            </div>
                        </div>

                        <div id="parada2Volta" style="display: none; margin-top: 10px;">
                            <h4 style="color: #d4af37; font-size: 0.9em; margin-bottom: 10px;">Parada 2</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                                <div class="form-group">
                                    <label>Cidade</label>
                                    <input type="text" id="cotacao_parada2CidadeVolta" placeholder="Ex: Miami" onblur="autoCompletarAeroporto('cotacao_parada2CidadeVolta')">
                                </div>
                                <div class="form-group">
                                    <label>Tempo de Espera</label>
                                    <input type="text" id="cotacao_parada2TempoVolta" placeholder="Ex: 1h 45min">
                                </div>
                            </div>
                        </div>

                        <div id="parada3Volta" style="display: none; margin-top: 10px;">
                            <h4 style="color: #d4af37; font-size: 0.9em; margin-bottom: 10px;">Parada 3</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                                <div class="form-group">
                                    <label>Cidade</label>
                                    <input type="text" id="cotacao_parada3CidadeVolta" placeholder="Ex: Lisboa" onblur="autoCompletarAeroporto('cotacao_parada3CidadeVolta')">
                                </div>
                                <div class="form-group">
                                    <label>Tempo de Espera</label>
                                    <input type="text" id="cotacao_parada3TempoVolta" placeholder="Ex: 3h">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <h3>Cálculo de Valores (Interno - Cliente não vê milhas)</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                    <div class="form-group">
                        <label>Quantidade de Milhas</label>
                        <input type="text" id="cotacao_milhas" placeholder="Ex: 15.000" oninput="calcularCotacao()">
                    </div>
                    <div class="form-group">
                        <label>Valor do Milheiro (R$)</label>
                        <input type="text" id="cotacao_valorMilheiro" placeholder="Ex: 31,00" oninput="calcularCotacao()">
                    </div>
                    <div class="form-group">
                        <label>Taxas de Embarque (R$)</label>
                        <input type="text" id="cotacao_taxas" placeholder="Ex: 250,00" oninput="calcularCotacao()">
                    </div>
                </div>

                <div class="info-text" style="margin-top: 15px; margin-bottom: 15px;">
                    <strong>VALOR POR PESSOA:</strong> <span id="cotacao_valorPessoa" style="color: #d4af37; font-size: 1.2em; font-weight: bold;">-</span><br>
                    <strong>VALOR TOTAL (PIX):</strong> <span id="cotacao_valorTotal" style="color: #d4af37; font-size: 1.2em; font-weight: bold;">-</span><br>
                    <strong>PARCELA 5x (CARTÃO):</strong> <span id="cotacao_parcela" style="color: #d4af37; font-size: 1.2em; font-weight: bold;">-</span><br>
                    <strong>TOTAL PARCELADO:</strong> <span id="cotacao_totalParcelado" style="color: #d4af37; font-size: 1.2em; font-weight: bold;">-</span>
                </div>

                <h3>Bagagem Incluída</h3>
                <div class="form-group">
                    <label>Descrição da Franquia de Bagagem</label>
                    <textarea id="cotacao_bagagem" rows="3" placeholder="Ex: 1 mala de mão (10kg) + 1 bagagem despachada (23kg)"></textarea>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 25px; flex-wrap: wrap;">
                    <button type="button" class="btn" onclick="copiarCotacaoWhatsApp()" style="background: #25D366; color: white; flex: 1; min-width: 200px;">Copiar para WhatsApp</button>
                    <button type="button" class="btn" onclick="gerarPDFCotacao()" style="background: #d32f2f; color: white; flex: 1; min-width: 200px;">Gerar PDF</button>
                    <button type="button" class="btn btn-primary" onclick="salvarCotacao()" style="flex: 1; min-width: 200px;">Salvar Cotação</button>
                </div>
            </form>

            <h3 style="margin-top: 40px;">Histórico de Cotações</h3>
            <div id="listaCotacoes"></div>
        </div>

        <div id="analises" class="tab-content">
            <h2>Análises e Insights</h2>

            <div class="info-text">
                Análises baseadas em todo o histórico de agendamentos (ativos + arquivados)
            </div>

            <h3>Comparador de Companhias Aéreas</h3>
            <div class="form-group" style="max-width: 400px; margin-bottom: 20px;">
                <label>Filtrar por Itinerário (opcional)</label>
                <input type="text" id="filtro_comparador" placeholder="Ex: GRU - RIO" onkeyup="atualizarComparador()">
            </div>
            <div id="comparadorCompanhias"></div>

            <h3 style="margin-top: 40px;">Análise de Sazonalidade</h3>
            <div class="form-group" style="max-width: 400px; margin-bottom: 20px;">
                <label>Selecione a Região</label>
                <select id="filtro_sazonalidade" onchange="atualizarSazonalidade()">
                    <option value="todas">Todas as Regiões</option>
                    <option value="Norte">Norte</option>
                    <option value="Nordeste">Nordeste</option>
                    <option value="Centro-Oeste">Centro-Oeste</option>
                    <option value="Sudeste">Sudeste</option>
                    <option value="Sul">Sul</option>
                </select>
            </div>
            <div id="sazonalidade"></div>
        </div>

        <div id="configuracoes" class="tab-content">
            <h2>Configurações e Dados</h2>
            <div style="display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap;">
                <button class="btn btn-primary" onclick="document.getElementById('fileImport').click()">Importar Dados (JSON)</button>
                <input type="file" id="fileImport" accept=".json" style="display: none;" onchange="importarDados(event)">
                <button class="btn btn-primary" onclick="exportarExcel()">Exportar Agendamentos (CSV)</button>
                <button class="btn btn-primary" onclick="exportarHistorico()">Exportar Histórico (CSV)</button>
                <button class="btn btn-secondary" onclick="backupDados()">Backup Completo</button>
                <button class="btn btn-danger" onclick="zerarSistema()">ZERAR SISTEMA COMPLETO</button>
            </div>

            <div style="background: #1a2942; border-left: 4px solid #d32f2f; padding: 15px; margin-top: 20px; border-radius: 5px;">
                <strong style="color: #d32f2f;">ATENÇÃO: Zerar Sistema</strong>
                <p style="margin-top: 10px; color: #ccc;">O botão vermelho acima irá apagar TODOS os dados:</p>
                <ul style="margin-top: 10px; color: #ccc; margin-left: 20px;">
                    <li>Agendamentos</li>
                    <li>Histórico</li>
                    <li>Cotações</li>
                    <li>Configurações</li>
                </ul>
                <p style="margin-top: 10px; color: #d32f2f; font-weight: bold;">Esta ação NÃO pode ser desfeita. Use com cuidado!</p>
            </div>

            <div class="info-text" style="margin-top: 20px;">
                <strong>Como importar seus agendamentos:</strong><br>
                1. Clique em "Importar Dados (JSON)"<br>
                2. Selecione o arquivo "agendamentos_para_importar.json"<br>
                3. Os dados serão carregados automaticamente!
            </div>

            <div class="config-section">
                <h3>Sobre o Sistema</h3>
                <p>Sistema de Controle de Agendamentos - Versão 1.0</p>
                <p style="margin-top: 10px;">Os dados são salvos automaticamente no navegador (LocalStorage).</p>
                <p style="margin-top: 10px;">Para sincronizar entre dispositivos, utilize a função de Backup/Restaurar.</p>
            </div>
        </div>
    </div>

    <script>
        let agendamentos = [];
        let historico = [];
        let cotacoes = [];
        let cotacaoMilha = 0.015; // Valor padrão

        function carregarDados() {
            const dadosSalvos = localStorage.getItem('agendamentos');
            if (dadosSalvos) {
                agendamentos = JSON.parse(dadosSalvos);
            } else {
                agendamentos = DADOS_INICIAIS;
                salvarDados();
            }

            const historicoSalvo = localStorage.getItem('historico');
            if (historicoSalvo) {
                historico = JSON.parse(historicoSalvo);
            }

            const cotacoesSalvas = localStorage.getItem('cotacoes');
            if (cotacoesSalvas) {
                cotacoes = JSON.parse(cotacoesSalvas);
            }

            const cotacaoSalva = localStorage.getItem('cotacaoMilha');
            if (cotacaoSalva) {
                cotacaoMilha = parseFloat(cotacaoSalva);
                document.getElementById('cotacaoMilha').value = cotacaoMilha;
            }

            atualizarTudo();
        }

        function salvarDados() {
            localStorage.setItem('agendamentos', JSON.stringify(agendamentos));
            localStorage.setItem('historico', JSON.stringify(historico));
            localStorage.setItem('cotacoes', JSON.stringify(cotacoes));
        }
        
        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
            
            if (tabName === 'disponibilidade') {
                renderizarDisponibilidade();
            } else if (tabName === 'agendamentos') {
                renderizarListaAgendamentos();
            } else if (tabName === 'historico') {
                filtrarHistorico();
            } else if (tabName === 'analises') {
                atualizarComparador();
                atualizarSazonalidade();
            }
        }
        
        function toggleFrequenciaPersonalizada() {
            const recorrencia = document.getElementById('recorrencia').value;
            const campoPersonalizado = document.getElementById('campoFrequenciaPersonalizada');

            if (recorrencia === 'Personalizado') {
                campoPersonalizado.style.display = 'block';
            } else {
                campoPersonalizado.style.display = 'none';
            }
        }

        function atualizarHorariosDisponiveis() {
            const regiao = document.getElementById('regiao').value;
            const selectHorario = document.getElementById('horario');

            if (!regiao) {
                selectHorario.innerHTML = '<option value="">Selecione a região primeiro</option>';
                return;
            }

            // Gerar todos os horários possíveis (das 08:00 às 21:00 de 30 em 30 min)
            const todosHorarios = [];
            for (let h = 8; h <= 21; h++) {
                todosHorarios.push(`${String(h).padStart(2, '0')}:00`);
                if (h < 21) {
                    todosHorarios.push(`${String(h).padStart(2, '0')}:30`);
                }
            }

            // Verificar quais horários já estão ocupados nessa região
            const horariosOcupados = agendamentos
                .filter(ag => ag.regiao === regiao)
                .map(ag => ag.horario);

            // Filtrar apenas horários disponíveis
            const horariosDisponiveis = todosHorarios.filter(h => !horariosOcupados.includes(h));

            // Preencher o select
            if (horariosDisponiveis.length === 0) {
                selectHorario.innerHTML = '<option value="">Nenhum horário disponível nesta região</option>';
            } else {
                selectHorario.innerHTML = '<option value="">Selecione um horário...</option>';
                horariosDisponiveis.forEach(horario => {
                    const option = document.createElement('option');
                    option.value = horario;
                    option.textContent = horario;
                    selectHorario.appendChild(option);
                });
            }
        }

        function cadastrarAgendamento(e) {
            e.preventDefault();

            const data = document.getElementById('data').value;
            const horario = document.getElementById('horario').value;
            const itinerario = document.getElementById('itinerario').value;
            const companhia = document.getElementById('companhia').value;
            const regiao = document.getElementById('regiao').value;
            const recorrencia = document.getElementById('recorrencia').value;
            const linkCompanhia = document.getElementById('linkCompanhia').value;
            const milhas = document.getElementById('milhas').value;
            const valorMilheiro = document.getElementById('valorMilheiro').value;
            const taxas = document.getElementById('taxas').value;
            const observacoes = document.getElementById('observacoes').value;
            const datasIda = document.getElementById('datasIda').value;
            const datasVolta = document.getElementById('datasVolta').value;
            const precoMedio = document.getElementById('precoMedio').value;

            const dataObj = new Date(data + 'T00:00:00');
            const diasSemana = ['Domingo', 'Segunda', 'Terça', 'Quarta', 'Quinta', 'Sexta', 'Sábado'];
            const diaSemana = diasSemana[dataObj.getDay()];

            const editandoIndex = document.getElementById('editandoIndex').value;

            if (editandoIndex !== '') {
                // Modo edição - atualizar agendamento existente
                const index = parseInt(editandoIndex);
                const agendamentoOriginal = agendamentos[index];

                agendamentos[index] = {
                    data: formatarData(data),
                    dia_semana: diaSemana,
                    horario: horario,
                    itinerario: itinerario,
                    companhia: companhia,
                    regiao: regiao,
                    recorrencia: recorrencia,
                    linkCompanhia: linkCompanhia,
                    milhas: milhas,
                    valorMilheiro: valorMilheiro,
                    taxas: taxas,
                    observacoes: observacoes,
                    datasIda: datasIda,
                    datasVolta: datasVolta,
                    precoMedio: precoMedio,
                    data_cadastro: agendamentoOriginal.data_cadastro,
                    hora_cadastro: agendamentoOriginal.hora_cadastro,
                    status: 'Agendado'
                };

                salvarDados();
                atualizarTudo();
                cancelarEdicao();
                alert('Agendamento atualizado com sucesso!');

            } else {
                // Modo cadastro - criar novo agendamento
                const agora = new Date();
                const dataCadastro = agora.toLocaleDateString('pt-BR');
                const horaCadastro = agora.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });

                agendamentos.push({
                    data: formatarData(data),
                    dia_semana: diaSemana,
                    horario: horario,
                    itinerario: itinerario,
                    companhia: companhia,
                    regiao: regiao,
                    recorrencia: recorrencia,
                    linkCompanhia: linkCompanhia,
                    milhas: milhas,
                    valorMilheiro: valorMilheiro,
                    taxas: taxas,
                    observacoes: observacoes,
                    datasIda: datasIda,
                    datasVolta: datasVolta,
                    precoMedio: precoMedio,
                    data_cadastro: dataCadastro,
                    hora_cadastro: horaCadastro,
                    status: 'Agendado'
                });

                salvarDados();
                atualizarTudo();
                document.getElementById('formCadastro').reset();
                alert('Agendamento cadastrado com sucesso!');
            }
        }

        function editarAgendamento(index) {
            const ag = agendamentos[index];

            // Converter data de DD/MM/YYYY para YYYY-MM-DD
            const [dia, mes, ano] = ag.data.split('/');
            const dataFormatada = `${ano}-${mes}-${dia}`;

            // Preencher formulário
            document.getElementById('data').value = dataFormatada;
            document.getElementById('horario').value = ag.horario;
            document.getElementById('itinerario').value = ag.itinerario;
            document.getElementById('companhia').value = ag.companhia || '';
            document.getElementById('regiao').value = ag.regiao;
            document.getElementById('recorrencia').value = ag.recorrencia;
            document.getElementById('linkCompanhia').value = ag.linkCompanhia || '';
            document.getElementById('milhas').value = ag.milhas || '';
            document.getElementById('valorMilheiro').value = ag.valorMilheiro || '';
            document.getElementById('taxas').value = ag.taxas || '';
            document.getElementById('observacoes').value = ag.observacoes || '';
            document.getElementById('datasIda').value = ag.datasIda || ag.datasDisponiveis || '';
            document.getElementById('datasVolta').value = ag.datasVolta || '';
            document.getElementById('precoMedio').value = ag.precoMedio || '';

            // Calcular custo total
            calcularCustoTotal();

            // Marcar como editando
            document.getElementById('editandoIndex').value = index;
            document.getElementById('tituloCadastro').textContent = 'Editar Agendamento';
            document.getElementById('btnSubmit').textContent = 'Salvar Alterações';
            document.getElementById('btnCancelar').style.display = 'block';

            // Ir para aba de cadastro
            document.querySelector('.tab:nth-child(2)').click();

            // Scroll para o topo
            window.scrollTo(0, 0);
        }

        function cancelarEdicao() {
            document.getElementById('formCadastro').reset();
            document.getElementById('editandoIndex').value = '';
            document.getElementById('tituloCadastro').textContent = 'Cadastrar Novo Agendamento';
            document.getElementById('btnSubmit').textContent = 'Cadastrar Agendamento';
            document.getElementById('btnCancelar').style.display = 'none';
        }
        
        function formatarData(data) {
            const [ano, mes, dia] = data.split('-');
            return `${dia}/${mes}/${ano}`;
        }

        function abrirLink() {
            const link = document.getElementById('link').value.trim();
            if (link) {
                if (link.startsWith('http://') || link.startsWith('https://')) {
                    window.open(link, '_blank');
                } else {
                    alert('Por favor, insira um link válido começando com http:// ou https://');
                }
            } else {
                alert('Por favor, preencha o campo de link primeiro!');
            }
        }

        function abrirLinkCompanhia() {
            const link = document.getElementById('linkCompanhia').value.trim();
            if (link) {
                if (link.startsWith('http://') || link.startsWith('https://')) {
                    window.open(link, '_blank');
                } else {
                    alert('Por favor, insira um link válido começando com http:// ou https://');
                }
            } else {
                alert('Por favor, preencha o campo de link da companhia primeiro!');
            }
        }

        function atualizarTudo() {
            atualizarDashboard();
            if (document.getElementById('disponibilidade').classList.contains('active')) {
                renderizarDisponibilidade();
            }
            if (document.getElementById('agendamentos').classList.contains('active')) {
                renderizarListaAgendamentos();
            }
            if (document.getElementById('cotacoes').classList.contains('active')) {
                atualizarListaCotacoes();
            }
        }
        
        function atualizarDashboard() {
            // Estatísticas básicas
            document.getElementById('totalAgendamentos').textContent = agendamentos.length;
            document.getElementById('totalHistorico').textContent = historico.length;
            document.getElementById('totalGeral').textContent = agendamentos.length + historico.length;

            const hoje = new Date().toLocaleDateString('pt-BR');
            const postagensHoje = agendamentos.filter(a => a.data === hoje).length;
            document.getElementById('postagensHoje').textContent = postagensHoje;

            // Combinar dados ativos e histórico para análises
            const todosDados = [...agendamentos, ...historico];

            // Calcular valores (apenas com dados completos)
            const dadosComValor = todosDados.filter(d => d.milhas && d.valorMilheiro);
            const valores = dadosComValor.map(d => {
                const milhasNum = parseFloat(d.milhas.replace(/[^\d]/g, ''));
                const valorMilheiroNum = parseFloat(d.valorMilheiro.replace(/[^\d,]/g, '').replace(',', '.'));
                const taxasNum = d.taxas ? parseFloat(d.taxas.replace(/[^\d,]/g, '').replace(',', '.')) : 0;
                return (milhasNum / 1000) * valorMilheiroNum + taxasNum;
            });

            if (valores.length > 0) {
                const soma = valores.reduce((a, b) => a + b, 0);
                const valorMedio = soma / valores.length;
                const ticketAlto = Math.max(...valores);
                const ticketBaixo = Math.min(...valores);

                document.getElementById('valorMedio').textContent = 'R$ ' + valorMedio.toFixed(2).replace('.', ',');
                document.getElementById('ticketAlto').textContent = 'R$ ' + ticketAlto.toFixed(2).replace('.', ',');
                document.getElementById('ticketBaixo').textContent = 'R$ ' + ticketBaixo.toFixed(2).replace('.', ',');
                document.getElementById('volumeTotal').textContent = 'R$ ' + soma.toFixed(2).replace('.', ',');
            } else {
                document.getElementById('valorMedio').textContent = '-';
                document.getElementById('ticketAlto').textContent = '-';
                document.getElementById('ticketBaixo').textContent = '-';
                document.getElementById('volumeTotal').textContent = '-';
            }

            // Performance por Companhia
            const companhias = ['Azul', 'Smiles', 'Latam'];
            let htmlComp = '<div class="stats-grid">';

            companhias.forEach(cia => {
                const dados = dadosComValor.filter(d => d.companhia === cia);
                if (dados.length > 0) {
                    const valoresCia = dados.map(d => {
                        const milhasNum = parseFloat(d.milhas.replace(/[^\d]/g, ''));
                        const valorMilheiroNum = parseFloat(d.valorMilheiro.replace(/[^\d,]/g, '').replace(',', '.'));
                        const taxasNum = d.taxas ? parseFloat(d.taxas.replace(/[^\d,]/g, '').replace(',', '.')) : 0;
                        return (milhasNum / 1000) * valorMilheiroNum + taxasNum;
                    });
                    const mediaCia = valoresCia.reduce((a, b) => a + b, 0) / valoresCia.length;

                    htmlComp += `
                        <div class="stat-card">
                            <h3>${cia}</h3>
                            <div class="value" style="font-size: 1.5em;">R$ ${mediaCia.toFixed(2).replace('.', ',')}</div>
                            <p style="color: #b0b0b0; font-size: 0.9em; margin-top: 10px;">${dados.length} alertas</p>
                        </div>
                    `;
                }
            });

            htmlComp += '</div>';
            document.getElementById('performanceCompanhias').innerHTML = htmlComp;

            // Top 5 Rotas
            const rotasValor = {};
            dadosComValor.forEach(d => {
                const milhasNum = parseFloat(d.milhas.replace(/[^\d]/g, ''));
                const valorMilheiroNum = parseFloat(d.valorMilheiro.replace(/[^\d,]/g, '').replace(',', '.'));
                const taxasNum = d.taxas ? parseFloat(d.taxas.replace(/[^\d,]/g, '').replace(',', '.')) : 0;
                const valor = (milhasNum / 1000) * valorMilheiroNum + taxasNum;

                if (!rotasValor[d.itinerario]) {
                    rotasValor[d.itinerario] = { total: 0, count: 0 };
                }
                rotasValor[d.itinerario].total += valor;
                rotasValor[d.itinerario].count++;
            });

            const topRotas = Object.entries(rotasValor)
                .map(([rota, data]) => ({ rota, media: data.total / data.count, count: data.count }))
                .sort((a, b) => b.media - a.media)
                .slice(0, 5);

            let htmlRotas = '';
            topRotas.forEach(item => {
                htmlRotas += `
                    <div class="distribuicao-box">
                        <span>${item.rota}</span>
                        <span style="color: #d4af37;">R$ ${item.media.toFixed(2).replace('.', ',')}</span>
                        <span>${item.count} alertas</span>
                    </div>
                `;
            });
            document.getElementById('topRotas').innerHTML = htmlRotas || '<p style="color: #b0b0b0;">Nenhuma rota cadastrada ainda</p>';

            // Distribuição por Região
            const regioes = ['Norte', 'Nordeste', 'Centro-Oeste', 'Sudeste', 'Sul'];
            let htmlReg = '';

            regioes.forEach(regiao => {
                const count = agendamentos.filter(a => a.regiao === regiao).length;
                const percent = agendamentos.length > 0 ? (count / agendamentos.length * 100).toFixed(1) : 0;
                htmlReg += `
                    <div class="distribuicao-box">
                        <span>${regiao}</span>
                        <span>${count}</span>
                        <span>${percent}%</span>
                    </div>
                `;
            });

            document.getElementById('distribuicaoRegioes').innerHTML = htmlReg;

            // Últimos 7 dias
            const ultimos7 = [];
            const dataHoje = new Date();

            for (let i = 6; i >= 0; i--) {
                const data = new Date(dataHoje);
                data.setDate(dataHoje.getDate() - i);
                const dataStr = data.toLocaleDateString('pt-BR');

                const cadastrosNoDia = todosDados.filter(d => d.data_cadastro === dataStr).length;

                ultimos7.push({ data: dataStr, count: cadastrosNoDia });
            }

            let html7Dias = '';
            ultimos7.forEach(item => {
                const larguraBarra = ultimos7.length > 0 ? (item.count / Math.max(...ultimos7.map(x => x.count), 1) * 100) : 0;

                html7Dias += `
                    <div class="distribuicao-box" style="position: relative; overflow: hidden;">
                        <div style="position: absolute; left: 0; top: 0; bottom: 0; width: ${larguraBarra}%; background: rgba(212, 175, 55, 0.15); z-index: 0;"></div>
                        <span style="position: relative; z-index: 1;">${item.data}</span>
                        <span style="position: relative; z-index: 1;">${item.count}</span>
                        <span style="position: relative; z-index: 1;">alertas</span>
                    </div>
                `;
            });

            document.getElementById('ultimos7Dias').innerHTML = html7Dias;
        }
        
        function renderizarDisponibilidade() {
            let regioesFiltradas = ['Norte', 'Nordeste', 'Centro-Oeste', 'Sudeste', 'Sul'];

            const regiaoSelecionada = document.getElementById('regiaoFiltro')?.value || 'Todas';

            if (regiaoSelecionada !== 'Todas') {
                regioesFiltradas = [regiaoSelecionada];
            }

            const horarios = ['08:00', '08:30', '09:00', '09:30', '10:00', '10:30', '11:00', '11:30',
                              '12:00', '12:30', '13:00', '13:30', '14:00', '14:30', '15:00', '15:30',
                              '16:00', '16:30', '17:00', '17:30', '18:00', '18:30', '19:00', '19:30',
                              '20:00', '20:30', '21:00'];

            const dataInicio = new Date('2026-01-21');
            const dias = [];
            for (let i = 0; i < 7; i++) {
                const data = new Date(dataInicio);
                data.setDate(dataInicio.getDate() + i);
                dias.push(data);
            }

            let html = '';

            regioesFiltradas.forEach(regiao => {
                html += `<div class="region-section">`;
                html += `<div class="region-title">REGIÃO: ${regiao.toUpperCase()}</div>`;
                html += `<div class="time-grid">`;
                
                html += `<div class="time-header">Horário</div>`;
                dias.forEach(dia => {
                    const nomeDia = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'][dia.getDay()];
                    html += `<div class="day-header">${nomeDia}<br>${dia.getDate()}/${(dia.getMonth()+1).toString().padStart(2,'0')}</div>`;
                });
                
                horarios.forEach(horario => {
                    html += `<div class="time-header">${horario}</div>`;
                    
                    dias.forEach(dia => {
                        const ocupado = verificarOcupado(regiao, horario, dia);
                        const classe = ocupado ? 'ocupado' : 'livre';
                        const texto = ocupado ? 'X' : 'OK';
                        html += `<div class="time-cell ${classe}" onclick="selecionarHorario('${regiao}', '${horario}', '${dia.toISOString().split('T')[0]}')">${texto}</div>`;
                    });
                });
                
                html += `</div></div>`;
            });
            
            document.getElementById('disponibilidadeContent').innerHTML = html;
        }
        
        function verificarOcupado(regiao, horario, dia) {
            return agendamentos.some(ag => {
                if (ag.regiao !== regiao || ag.horario !== horario) return false;
                
                const dataAg = parseData(ag.data);
                const recorrencia = ag.recorrencia || 'Diário';
                
                if (recorrencia === 'Diário') {
                    return dia >= dataAg;
                } else if (recorrencia === 'Dias Alternados') {
                    const diffDias = Math.floor((dia - dataAg) / (1000 * 60 * 60 * 24));
                    return diffDias >= 0 && diffDias % 2 === 0;
                } else {
                    return dia.toDateString() === dataAg.toDateString();
                }
            });
        }
        
        function parseData(dataStr) {
            const [dia, mes, ano] = dataStr.split('/');
            return new Date(ano, mes - 1, dia);
        }
        
        function selecionarHorario(regiao, horario, data) {
            document.getElementById('regiao').value = regiao;
            document.getElementById('horario').value = horario;
            document.getElementById('data').value = data;
            document.querySelector('.tab:nth-child(2)').click();
        }
        
        let filtroRegiaoAtual = 'Todas';
        
        function renderizarListaAgendamentos() {
            let agendamentosFiltrados = agendamentos;
            
            if (filtroRegiaoAtual !== 'Todas') {
                agendamentosFiltrados = agendamentos.filter(a => a.regiao === filtroRegiaoAtual);
            }
            
            const busca = document.getElementById('searchBox')?.value.toLowerCase() || '';
            if (busca) {
                agendamentosFiltrados = agendamentosFiltrados.filter(a => 
                    a.itinerario.toLowerCase().includes(busca) ||
                    a.regiao.toLowerCase().includes(busca)
                );
            }
            
            if (agendamentosFiltrados.length === 0) {
                document.getElementById('listaAgendamentos').innerHTML = `
                    <div class="empty-state">
                        <h3>Nenhum agendamento encontrado</h3>
                        <p>Tente ajustar os filtros ou adicionar novos agendamentos</p>
                    </div>
                `;
                return;
            }
            
            let html = '<table class="agendamentos-table"><thead><tr>';
            html += '<th>Data Agend.</th><th>Dia</th><th>Horário</th><th>Itinerário</th><th>Cia Aérea</th><th>Região</th><th>Recorrência</th><th>Milhas</th><th>R$/Milheiro</th><th>Taxas</th><th>Custo Total</th><th>Observações</th><th>Cadastrado em</th><th>Link</th><th>Ações</th>';
            html += '</tr></thead><tbody>';

            agendamentosFiltrados.forEach((ag, index) => {
                const badgeClass = ag.recorrencia === 'Diário' ? 'badge-diario' :
                                   ag.recorrencia === 'Dias Alternados' ? 'badge-alternado' : 'badge-uma-vez';
                const realIndex = agendamentos.indexOf(ag);
                const linkBtn = ag.link ? `<button class="btn btn-secondary" style="padding: 6px 12px; font-size: 0.8em;" onclick="window.open('${ag.link}', '_blank')">Abrir</button>` : '-';
                const milhasTexto = ag.milhas || '-';
                const valorMilheiroTexto = ag.valorMilheiro ? 'R$ ' + ag.valorMilheiro : '-';
                const taxasTexto = ag.taxas || '-';
                const companhiaTexto = ag.companhia || '-';
                const obsTexto = ag.observacoes || '-';
                const cadastroTexto = ag.data_cadastro && ag.hora_cadastro ? `${ag.data_cadastro}<br>${ag.hora_cadastro}` : '-';

                // Calcular custo total
                let custoTotalTexto = '-';
                if (ag.milhas && ag.valorMilheiro) {
                    const milhasNum = parseFloat(ag.milhas.replace(/[^\d]/g, ''));
                    const valorMilheiroNum = parseFloat(ag.valorMilheiro.replace(/[^\d,]/g, '').replace(',', '.'));
                    const taxasNum = ag.taxas ? parseFloat(ag.taxas.replace(/[^\d,]/g, '').replace(',', '.')) : 0;
                    const custoMilhas = (milhasNum / 1000) * valorMilheiroNum;
                    const total = custoMilhas + taxasNum;
                    custoTotalTexto = 'R$ ' + total.toFixed(2).replace('.', ',');
                }
                html += `<tr>
                    <td>${ag.data}</td>
                    <td>${ag.dia_semana}</td>
                    <td>${ag.horario}</td>
                    <td>${ag.itinerario}</td>
                    <td>${companhiaTexto}</td>
                    <td>${ag.regiao}</td>
                    <td><span class="badge ${badgeClass}">${ag.recorrencia}</span></td>
                    <td>${milhasTexto}</td>
                    <td>${valorMilheiroTexto}</td>
                    <td>${taxasTexto}</td>
                    <td style="font-weight: bold; color: #d4af37;">${custoTotalTexto}</td>
                    <td style="font-size: 0.85em; max-width: 200px;">${obsTexto}</td>
                    <td style="font-size: 0.85em;">${cadastroTexto}</td>
                    <td>${linkBtn}</td>
                    <td>
                        <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                            <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 0.8em;" onclick="editarAgendamento(${realIndex})">Editar</button>
                            <button class="btn btn-warning" style="padding: 6px 12px; font-size: 0.8em;" onclick="excluirAgendamento(${realIndex})">Arquivar</button>
                            <button class="btn btn-danger" style="padding: 6px 12px; font-size: 0.8em;" onclick="excluirPermanente(${realIndex})">Excluir</button>
                        </div>
                    </td>
                </tr>`;
            });
            
            html += '</tbody></table>';
            document.getElementById('listaAgendamentos').innerHTML = html;
        }
        
        function filtrarPorRegiao(regiao) {
            filtroRegiaoAtual = regiao;
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            renderizarListaAgendamentos();
        }
        
        function filtrarAgendamentos() {
            renderizarListaAgendamentos();
        }
        
        function excluirAgendamento(index) {
            if (confirm('Deseja arquivar este agendamento? Ele será movido para o Histórico.')) {
                const agendamento = agendamentos[index];

                // Adicionar data de arquivamento
                const agora = new Date();
                agendamento.data_arquivamento = agora.toLocaleDateString('pt-BR');
                agendamento.hora_arquivamento = agora.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });

                // Mover para histórico
                historico.push(agendamento);

                // Remover dos agendamentos ativos
                agendamentos.splice(index, 1);

                salvarDados();
                atualizarTudo();
                alert('Agendamento arquivado com sucesso! Veja na aba Histórico.');
            }
        }

        function excluirPermanente(index) {
            if (confirm('⚠️ ATENÇÃO: Tem certeza que deseja EXCLUIR permanentemente este agendamento?\n\nEsta ação NÃO pode ser desfeita e o alerta será DELETADO para sempre (não vai para o histórico).')) {
                // Remove permanentemente dos agendamentos ativos
                agendamentos.splice(index, 1);

                salvarDados();
                atualizarTudo();
                alert('✅ Agendamento excluído permanentemente!');
            }
        }

        function exportarExcel() {
            let csv = 'Data Agendamento,Dia Semana,Horário,Itinerário,Companhia,Região,Recorrência,Milhas,Valor Milheiro,Taxas,Observações,Data Cadastro,Hora Cadastro,Link,Status\n';
            agendamentos.forEach(ag => {
                csv += `${ag.data},${ag.dia_semana},${ag.horario},${ag.itinerario},"${ag.companhia || ''}",${ag.regiao},${ag.recorrencia},"${ag.milhas || ''}","${ag.valorMilheiro || ''}","${ag.taxas || ''}","${ag.observacoes || ''}","${ag.data_cadastro || ''}","${ag.hora_cadastro || ''}","${ag.link || ''}",${ag.status}\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'agendamentos_' + new Date().toISOString().split('T')[0] + '.csv';
            link.click();
            alert('Arquivo Excel exportado com sucesso!');
        }
        
        function backupDados() {
            const backup = {
                agendamentos: agendamentos,
                historico: historico,
                data_backup: new Date().toLocaleString('pt-BR')
            };
            const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'backup_completo_' + new Date().toISOString().split('T')[0] + '.json';
            link.click();
            alert('Backup completo realizado com sucesso!');
        }

        function exportarHistorico() {
            if (historico.length === 0) {
                alert('Não há dados no histórico para exportar!');
                return;
            }

            let csv = 'Data Agendamento,Dia Semana,Horário,Itinerário,Companhia,Região,Recorrência,Milhas,Valor Milheiro,Taxas,Observações,Data Cadastro,Hora Cadastro,Data Arquivamento,Hora Arquivamento,Link\n';
            historico.forEach(ag => {
                csv += `${ag.data},${ag.dia_semana},${ag.horario},${ag.itinerario},"${ag.companhia || ''}",${ag.regiao},${ag.recorrencia},"${ag.milhas || ''}","${ag.valorMilheiro || ''}","${ag.taxas || ''}","${ag.observacoes || ''}","${ag.data_cadastro || ''}","${ag.hora_cadastro || ''}","${ag.data_arquivamento || ''}","${ag.hora_arquivamento || ''}","${ag.link || ''}"\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'historico_' + new Date().toISOString().split('T')[0] + '.csv';
            link.click();
            alert('Histórico exportado com sucesso!');
        }
        
        function importarDados(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const dadosImportados = JSON.parse(e.target.result);

                    if (!Array.isArray(dadosImportados)) {
                        alert('Erro: O arquivo não contém um formato válido!');
                        return;
                    }

                    if (agendamentos.length > 0) {
                        if (confirm(`Você já tem ${agendamentos.length} agendamentos. Deseja SUBSTITUIR todos pelos dados importados?`)) {
                            agendamentos = dadosImportados;
                        } else if (confirm('Deseja ADICIONAR os dados importados aos existentes?')) {
                            agendamentos = agendamentos.concat(dadosImportados);
                        } else {
                            return;
                        }
                    } else {
                        agendamentos = dadosImportados;
                    }

                    salvarDados();
                    atualizarTudo();
                    alert(`Sucesso! ${dadosImportados.length} agendamentos importados!`);

                } catch (error) {
                    alert('Erro ao importar arquivo: ' + error.message);
                }
            };
            reader.readAsText(file);

            // Limpar input para permitir reimportação
            event.target.value = '';
        }

        function limparTodos() {
            if (confirm('ATENÇÃO! Isso vai apagar TODOS os agendamentos. Tem certeza?')) {
                if (confirm('Última confirmação! Deseja realmente excluir TUDO?')) {
                    agendamentos = [];
                    salvarDados();
                    atualizarTudo();
                    alert('Todos os dados foram limpos!');
                }
            }
        }

        // ===== FUNÇÕES DO HISTÓRICO =====

        function filtrarHistorico() {
            const periodo = document.getElementById('filtro_periodo')?.value || 'todos';
            const itinerario = document.getElementById('filtro_itinerario')?.value.toLowerCase() || '';
            const companhia = document.getElementById('filtro_companhia')?.value || 'todas';
            const regiao = document.getElementById('filtro_regiao_hist')?.value || 'todas';

            let historicoFiltrado = [...historico];

            // Filtrar por período
            if (periodo !== 'todos') {
                const diasAtras = parseInt(periodo);
                const dataLimite = new Date();
                dataLimite.setDate(dataLimite.getDate() - diasAtras);

                historicoFiltrado = historicoFiltrado.filter(h => {
                    const dataArq = parseData(h.data_arquivamento);
                    return dataArq >= dataLimite;
                });
            }

            // Filtrar por itinerário
            if (itinerario) {
                historicoFiltrado = historicoFiltrado.filter(h =>
                    h.itinerario.toLowerCase().includes(itinerario)
                );
            }

            // Filtrar por companhia
            if (companhia !== 'todas') {
                historicoFiltrado = historicoFiltrado.filter(h => h.companhia === companhia);
            }

            // Filtrar por região
            if (regiao !== 'todas') {
                historicoFiltrado = historicoFiltrado.filter(h => h.regiao === regiao);
            }

            renderizarEstatisticas(historicoFiltrado);
            renderizarListaHistorico(historicoFiltrado);
        }

        function renderizarEstatisticas(dados) {
            if (dados.length === 0) {
                document.getElementById('estatisticasHistorico').innerHTML = '';
                return;
            }

            // Calcular estatísticas
            const totalRegistros = dados.length;

            // Média de milhas
            const dadosComMilhas = dados.filter(d => d.milhas && d.milhas.trim() !== '');
            let mediaMilhas = 0;
            if (dadosComMilhas.length > 0) {
                const somaMilhas = dadosComMilhas.reduce((acc, d) => {
                    const valor = parseFloat(d.milhas.replace(/[^\d]/g, ''));
                    return acc + (isNaN(valor) ? 0 : valor);
                }, 0);
                mediaMilhas = Math.round(somaMilhas / dadosComMilhas.length);
            }

            // Média de taxas
            const dadosComTaxas = dados.filter(d => d.taxas && d.taxas.trim() !== '');
            let mediaTaxas = 0;
            if (dadosComTaxas.length > 0) {
                const somaTaxas = dadosComTaxas.reduce((acc, d) => {
                    const valor = parseFloat(d.taxas.replace(/[^\d,]/g, '').replace(',', '.'));
                    return acc + (isNaN(valor) ? 0 : valor);
                }, 0);
                mediaTaxas = (somaTaxas / dadosComTaxas.length).toFixed(2);
            }

            // Rotas mais frequentes
            const rotas = {};
            dados.forEach(d => {
                rotas[d.itinerario] = (rotas[d.itinerario] || 0) + 1;
            });
            const rotasOrdenadas = Object.entries(rotas)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);

            let html = '<div class="stats-grid" style="margin-bottom: 30px;">';
            html += `
                <div class="stat-card">
                    <h3>Total de Registros</h3>
                    <div class="value">${totalRegistros}</div>
                </div>
                <div class="stat-card">
                    <h3>Média de Milhas</h3>
                    <div class="value">${mediaMilhas > 0 ? mediaMilhas.toLocaleString('pt-BR') : '-'}</div>
                </div>
                <div class="stat-card">
                    <h3>Média de Taxas</h3>
                    <div class="value">${mediaTaxas > 0 ? 'R$ ' + mediaTaxas : '-'}</div>
                </div>
            `;
            html += '</div>';

            if (rotasOrdenadas.length > 0) {
                html += '<h3>Top 5 Rotas Mais Frequentes</h3>';
                rotasOrdenadas.forEach(([rota, qtd]) => {
                    html += `
                        <div class="distribuicao-box">
                            <span>${rota}</span>
                            <span>${qtd}</span>
                            <span>${((qtd / totalRegistros) * 100).toFixed(1)}%</span>
                        </div>
                    `;
                });
            }

            document.getElementById('estatisticasHistorico').innerHTML = html;
        }

        function renderizarListaHistorico(dados) {
            if (dados.length === 0) {
                document.getElementById('listaHistorico').innerHTML = `
                    <div class="empty-state">
                        <h3>Nenhum registro encontrado</h3>
                        <p>Ajuste os filtros ou aguarde até arquivar agendamentos</p>
                    </div>
                `;
                return;
            }

            let html = '<table class="agendamentos-table"><thead><tr>';
            html += '<th>Data Agend.</th><th>Itinerário</th><th>Cia Aérea</th><th>Região</th><th>Milhas</th><th>Taxas</th><th>Arquivado em</th><th>Ações</th>';
            html += '</tr></thead><tbody>';

            dados.forEach((ag, index) => {
                const milhasTexto = ag.milhas || '-';
                const taxasTexto = ag.taxas || '-';
                const companhiaTexto = ag.companhia || '-';
                const arquivadoTexto = ag.data_arquivamento && ag.hora_arquivamento ? `${ag.data_arquivamento}<br>${ag.hora_arquivamento}` : '-';
                const linkBtn = ag.link ? `<button class="btn btn-secondary" style="padding: 6px 12px; font-size: 0.8em;" onclick="window.open('${ag.link}', '_blank')">Abrir</button>` : '-';

                const realIndex = historico.indexOf(ag);

                html += `<tr>
                    <td>${ag.data}</td>
                    <td>${ag.itinerario}</td>
                    <td>${companhiaTexto}</td>
                    <td>${ag.regiao}</td>
                    <td>${milhasTexto}</td>
                    <td>${taxasTexto}</td>
                    <td style="font-size: 0.85em;">${arquivadoTexto}</td>
                    <td>
                        <div style="display: flex; gap: 5px;">
                            ${linkBtn}
                            <button class="btn btn-primary" style="padding: 6px 12px; font-size: 0.8em;" onclick="restaurarAgendamento(${realIndex})">Restaurar</button>
                        </div>
                    </td>
                </tr>`;
            });

            html += '</tbody></table>';
            document.getElementById('listaHistorico').innerHTML = html;
        }

        function restaurarAgendamento(index) {
            if (confirm('Deseja restaurar este agendamento para a lista ativa?')) {
                const agendamento = historico[index];

                // Remover campos de arquivamento
                delete agendamento.data_arquivamento;
                delete agendamento.hora_arquivamento;

                // Adicionar de volta aos agendamentos ativos
                agendamentos.push(agendamento);

                // Remover do histórico
                historico.splice(index, 1);

                salvarDados();
                atualizarTudo();
                filtrarHistorico();

                alert('Agendamento restaurado com sucesso!');
            }
        }

        // ===== CALCULADORA DE CUSTO TOTAL =====

        function calcularCustoTotal() {
            const milhasInput = document.getElementById('milhas').value;
            const valorMilheiroInput = document.getElementById('valorMilheiro').value;
            const taxasInput = document.getElementById('taxas').value;

            if (!milhasInput && !taxasInput) {
                document.getElementById('custoTotal').textContent = '-';
                document.getElementById('precoCartao').textContent = '-';
                return;
            }

            // Extrair número de milhas
            const milhasNum = parseFloat(milhasInput.replace(/[^\d]/g, ''));

            // Extrair valor do milheiro
            const valorMilheiroNum = parseFloat(valorMilheiroInput.replace(/[^\d,]/g, '').replace(',', '.'));

            // Calcular custo das milhas: (milhas / 1000) × valor do milheiro
            const custoMilhas = (!isNaN(milhasNum) && !isNaN(valorMilheiroNum)) ? (milhasNum / 1000) * valorMilheiroNum : 0;

            // Extrair valor das taxas
            const taxasNum = parseFloat(taxasInput.replace(/[^\d,]/g, '').replace(',', '.'));
            const custoTaxas = isNaN(taxasNum) ? 0 : taxasNum;

            const total = custoMilhas + custoTaxas;

            if (total > 0) {
                const detalhes = [];
                if (custoMilhas > 0) {
                    detalhes.push(`${milhasNum.toLocaleString('pt-BR')} milhas × R$ ${valorMilheiroNum.toFixed(2)} = R$ ${custoMilhas.toFixed(2)}`);
                }
                if (custoTaxas > 0) {
                    detalhes.push(`Taxas: R$ ${custoTaxas.toFixed(2)}`);
                }

                document.getElementById('custoTotal').textContent =
                    `R$ ${total.toFixed(2).replace('.', ',')} (${detalhes.join(' + ')})`;

                // Calcular preço no cartão: 5x com juros de 8,8%
                const precoCartao = total * 1.088;
                const parcelaMensal = precoCartao / 5;
                document.getElementById('precoCartao').textContent =
                    `R$ ${precoCartao.toFixed(2).replace('.', ',')} (5x de R$ ${parcelaMensal.toFixed(2).replace('.', ',')})`;
            } else {
                document.getElementById('custoTotal').textContent = '-';
                document.getElementById('precoCartao').textContent = '-';
            }
        }

        function calcularPrecoMedio() {
            // Pegar o itinerário para determinar se é nacional ou internacional
            const itinerario = document.getElementById('itinerario').value.toUpperCase();

            // Verificar se tem custo total calculado
            const milhasInput = document.getElementById('milhas').value;
            const valorMilheiroInput = document.getElementById('valorMilheiro').value;
            const taxasInput = document.getElementById('taxas').value;

            if (!milhasInput || !valorMilheiroInput) {
                alert('Por favor, preencha Milhas e Valor do Milheiro primeiro!');
                return;
            }

            // Calcular custo total (PIX)
            const milhasNum = parseFloat(milhasInput.replace(/[^\d]/g, ''));
            const valorMilheiroNum = parseFloat(valorMilheiroInput.replace(/[^\d,]/g, '').replace(',', '.'));
            const custoMilhas = (milhasNum / 1000) * valorMilheiroNum;
            const taxasNum = taxasInput ? parseFloat(taxasInput.replace(/[^\d,]/g, '').replace(',', '.')) : 0;
            const custoTotalPix = custoMilhas + (isNaN(taxasNum) ? 0 : taxasNum);

            // Determinar se é nacional ou internacional
            // Internacional geralmente tem 3 letras nos códigos (ex: GRU-MIA)
            const isInternacional = /[A-Z]{3}/.test(itinerario) && itinerario.includes('-');

            let precoMedio;
            if (isInternacional) {
                // +30% para internacional
                precoMedio = custoTotalPix * 1.30;
            } else {
                // +40% para nacional
                precoMedio = custoTotalPix * 1.40;
            }

            document.getElementById('precoMedio').value = precoMedio.toFixed(2).replace('.', ',');

            const tipo = isInternacional ? 'internacional (+30%)' : 'nacional (+40%)';
            alert(`Preço médio calculado para voo ${tipo}: R$ ${precoMedio.toFixed(2).replace('.', ',')}`);
        }

        function salvarCotacaoMilha() {
            const valor = parseFloat(document.getElementById('cotacaoMilha').value);
            if (!isNaN(valor) && valor > 0) {
                cotacaoMilha = valor;
                localStorage.setItem('cotacaoMilha', cotacaoMilha);
                calcularCustoTotal();
                alert('Cotação salva com sucesso!');
            }
        }

        // --- FUNÇÃO 1: GERAÇÃO DO LINK (CORRIGIDA E BLINDADA) ---
        function gerarLinkLandingPage() {
            console.log('🏁 FUNÇÃO gerarLinkLandingPage INICIADA!');
            try {
                // CORREÇÃO CRÍTICA: Verifica se o elemento existe antes de tentar ler o valor
                const elUrlBase = document.getElementById('urlLandingPage');
                const urlBase = elUrlBase ? elUrlBase.value : 'https://voecomkennedy.github.io/EMISSAO/';

                // Mapeamento de Aeroportos
                const iataMap = {
                    "São Paulo": "SAO", "Rio de Janeiro": "RIO", "Belo Horizonte": "BHZ",
                    "Brasília": "BSB", "Salvador": "SSA", "Fortaleza": "FOR",
                    "Curitiba": "CWB", "Florianópolis": "FLN", "Porto Alegre": "POA",
                    "Recife": "REC", "Goiânia": "GYN", "Vitória": "VIX",
                    "Manaus": "MAO", "Belém": "BEL", "Natal": "NAT",
                    "Maceió": "MCZ", "João Pessoa": "JPA", "Aracaju": "AJU",
                    "Teresina": "THE", "São Luís": "SLZ", "Palmas": "PMW",
                    "Campo Grande": "CGR", "Cuiabá": "CGB", "Porto Velho": "PVH",
                    "Rio Branco": "RBR", "Boa Vista": "BVB", "Macapá": "MCP",
                    "Navegantes": "NVT", "Lima": "LIM", "Miami": "MIA",
                    "Orlando": "MCO", "Nova York": "NYC", "Buenos Aires": "BUE",
                    "Santiago": "SCL", "Lisboa": "LIS", "Paris": "PAR", "Madrid": "MAD",
                    "Roma": "ROM", "Dubai": "DXB"
                };

                const cleanText = (text) => text ? text.normalize('NFD').replace(/[\u0300-\u036f]/g, '') : '';

                // Captura os valores do formulário
                const itinerario = document.getElementById('itinerario').value;
                const companhia = document.getElementById('companhia').value;

                // Separa Origem e Destino (aceita setas variadas)
                const partes = itinerario.split(/➝|->|-/);
                if (partes.length < 2) return { url: urlBase, ref: '' };

                const origemOriginal = partes[0].trim();
                const destinoOriginal = partes[1].trim();
                const origemClean = cleanText(origemOriginal);
                const destinoClean = cleanText(destinoOriginal);

                // Prepara parâmetros da URL
                const p_origem = encodeURIComponent(origemClean);
                const p_destino = encodeURIComponent(destinoClean);
                const p_cia = companhia.toUpperCase();

                // Tratamento de Valores
                const milhasInput = document.getElementById('milhas').value;
                const valorMilheiroInput = document.getElementById('valorMilheiro').value;
                const taxasInput = document.getElementById('taxas').value;

                let p_valor = '';
                let valorParaRef = 0;

                if (milhasInput && valorMilheiroInput) {
                    const milhasNum = parseFloat(milhasInput.replace(/[^\d]/g, ''));
                    const valorMilheiroNum = parseFloat(valorMilheiroInput.replace(/[^\d,]/g, '').replace(',', '.'));
                    const taxasNum = taxasInput ? parseFloat(taxasInput.replace(/[^\d,]/g, '').replace(',', '.')) : 0;

                    const custoMilhas = (milhasNum / 1000) * valorMilheiroNum;
                    const custoTotalPix = custoMilhas + (isNaN(taxasNum) ? 0 : taxasNum);

                    // Valor para URL: Apenas números (centavos sem pontuação)
                    p_valor = custoTotalPix.toFixed(2).replace('.', '').replace(',', '');
                    valorParaRef = Math.floor(custoTotalPix);
                }

                // Datas
                const datasIdaTexto = document.getElementById('datasIda').value;
                const datasVoltaTexto = document.getElementById('datasVolta').value;
                // Assume que a função converterDatasParaParametros já existe no código
                const p_idas = typeof converterDatasParaParametros === 'function' ? converterDatasParaParametros(datasIdaTexto) : '';
                const p_voltas = typeof converterDatasParaParametros === 'function' ? converterDatasParaParametros(datasVoltaTexto) : '';

                // Referência (sigla de 3 letras)
                const siglaOrigem = iataMap[origemOriginal] || iataMap[origemClean] || origemClean.substring(0, 3).toUpperCase();
                const siglaDestino = iataMap[destinoOriginal] || iataMap[destinoClean] || destinoClean.substring(0, 3).toUpperCase();
                const p_ref = `${siglaOrigem}-${siglaDestino}-${p_cia}-${valorParaRef}`;

                // Montagem Final
                let url = `${urlBase}?o=${p_origem}&d=${p_destino}&c=${p_cia}&v=${p_valor}&i=${p_idas}&r=${p_voltas}&ref=${p_ref}`;

                return { url, ref: p_ref };

            } catch (erro) {
                console.error('Erro ao gerar link:', erro);
                return { url: 'https://voecomkennedy.github.io/EMISSAO/', ref: 'ERRO' };
            }
        }

        function formatarDatasParaPost(datasTexto) {
            // Formato EXATO do modelo: manter por mês com separadores
            // Entrada: "Fev: 21, 22, 24, 25, 26\nMar: 14, 18, 26, 31"
            // Saída: "Fev: 21, 22, 24, 25, 26\n----------------\nMar: 14, 18, 26, 31\n----------------"

            if (!datasTexto || datasTexto.trim() === '') {
                return '';
            }

            const linhas = datasTexto.split('\n').filter(l => l.trim() !== '');
            const linhasFormatadas = [];

            linhas.forEach(linha => {
                linhasFormatadas.push(linha.trim());
                linhasFormatadas.push('----------------');
            });

            return linhasFormatadas.join('\n');
        }

        function converterDatasParaParametros(texto) {
            // PARSER DE DATAS - Conforme orientação do Gemini
            // Converte texto tipo "Fev: 18, 17\nMar: 04" para "260218|260217|260304"

            if (!texto || texto.trim() === '') {
                console.log('⚠️ Datas vazias');
                return '';
            }

            console.log('📅 Texto de entrada:', texto);

            const mesesMap = {
                "jan": "01", "fev": "02", "mar": "03", "abr": "04", "mai": "05", "jun": "06",
                "jul": "07", "ago": "08", "set": "09", "out": "10", "nov": "11", "dez": "12"
            };

            let datasFormatadas = [];

            // Quebra por linhas
            const linhas = texto.split('\n');

            console.log('📝 Linhas encontradas:', linhas.length);

            linhas.forEach(linha => {
                if (!linha.includes(':')) {
                    console.log('⏭️ Linha sem ":" ignorada:', linha);
                    return;
                }

                let [mesNome, diasStr] = linha.split(':');
                mesNome = mesNome.trim().toLowerCase().substring(0, 3);
                let mesNumero = mesesMap[mesNome];

                console.log(`🔍 Processando: "${linha}" → Mês: "${mesNome}" → Código: ${mesNumero}`);

                if (mesNumero) {
                    // Pega os dias, remove colchetes de imagem [cite...] se houver
                    let diasLimpos = diasStr.split('[')[0];
                    let dias = diasLimpos.split(/,|\s+/).filter(d => d.trim() !== "" && !isNaN(d));

                    console.log(`  📋 Dias encontrados:`, dias);

                    dias.forEach(dia => {
                        let diaFmt = dia.trim().padStart(2, '0');
                        let dataCompleta = `26${mesNumero}${diaFmt}`; // Ano fixo 26
                        datasFormatadas.push(dataCompleta);
                        console.log(`  ✅ Data: ${dia} → ${dataCompleta}`);
                    });
                } else {
                    console.log(`  ❌ Mês não reconhecido: "${mesNome}"`);
                }
            });

            const resultado = datasFormatadas.join('|');
            console.log('🎯 Resultado final:', resultado);
            return resultado;
        }

        function gerarPostCompleto() {
            // Validação
            const itinerario = document.getElementById('itinerario').value;
            const companhia = document.getElementById('companhia').value;
            if (!itinerario) { alert('Por favor, preencha o itinerário!'); return; }

            // Cálculos
            const milhasInput = document.getElementById('milhas').value;
            const valorMilheiroInput = document.getElementById('valorMilheiro').value;
            const taxasInput = document.getElementById('taxas').value;

            if (!milhasInput || !valorMilheiroInput) { alert('Preencha Milhas e Valor do Milheiro!'); return; }

            const milhasNum = parseFloat(milhasInput.replace(/[^\d]/g, ''));
            const valorMilheiroNum = parseFloat(valorMilheiroInput.replace(/[^\d,]/g, '').replace(',', '.'));
            const taxasNum = taxasInput ? parseFloat(taxasInput.replace(/[^\d,]/g, '').replace(',', '.')) : 0;

            const custoMilhas = (milhasNum / 1000) * valorMilheiroNum;
            const custoTotalPix = custoMilhas + (isNaN(taxasNum) ? 0 : taxasNum);

            // Cartão (5x com juros de 8.8%)
            const custoTotalCartao = custoTotalPix * 1.088;
            const parcelaCartao = custoTotalCartao / 5;

            // --- FORMATAÇÃO BRASILEIRA (CORRIGIDA) ---
            const valorPixFormatado = custoTotalPix.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            const parcelaFormatada = parcelaCartao.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

            // Preço Médio e Economia
            const precoMedioInput = document.getElementById('precoMedio').value;
            let infoPrecoTexto = '';

            if (precoMedioInput) {
                const precoMedioNum = parseFloat(precoMedioInput.replace(/[^\d,]/g, '').replace(',', '.'));
                const precoMedioFmt = precoMedioNum.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

                infoPrecoTexto += `\n❌ Preço médio: ${precoMedioFmt}`;

                const economia = precoMedioNum - custoTotalPix;
                if (economia > 0) {
                    const economiaFmt = economia.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                    infoPrecoTexto += `\n🤑 *ECONOMIA VoeComKennedy: ${economiaFmt}*`;
                }
            }

            // Datas
            const datasIda = document.getElementById('datasIda').value;
            const datasVolta = document.getElementById('datasVolta').value;
            let datasTexto = '';

            if (datasIda) datasTexto += `\n📅 *IDA:*\n\n${typeof formatarDatasParaPost === 'function' ? formatarDatasParaPost(datasIda) : datasIda}\n`;
            if (datasVolta) datasTexto += `\n📅 *VOLTA:*\n${typeof formatarDatasParaPost === 'function' ? formatarDatasParaPost(datasVolta) : datasVolta}`;

            // --- GERAÇÃO DO LINK ---
            const resultadoLink = gerarLinkLandingPage();
            const linkEmissao = resultadoLink.url;

            // *** AQUI ESTÁ O PULO DO GATO ***
            // Mostra o link na tela para você ver
            const campoLinkVisual = document.getElementById('linkGerado');
            if (campoLinkVisual) {
                campoLinkVisual.value = linkEmissao;
            }

            // Montagem do Post
            const itinerarioFmt = itinerario.toUpperCase().replace(/-/g, ' ⇄ ');
            const post = `✈️ ${itinerarioFmt}

🏢 Companhia: ${companhia || 'N/A'}

💰 *${valorPixFormatado}* (IDA E VOLTA via Pix)
💳 5x de ${parcelaFormatada} (no cartão, com acréscimo)
${infoPrecoTexto}${datasTexto}

✅ Taxas de embarque já inclusas.
⚠️ Tarifas dinâmicas, sujeitas a alteração.

👇 DESEJA EMITIR?
${linkEmissao}

#VoeComKennedy #AlertaExclusivo
---
🌍 QUER OUTRA DATA OU DESTINO?
Não achou o que procurava? A gente cota qualquer viagem para você aqui:
👉 https://voecomkennedy.github.io/COTACAO/
---`;

            // Copiar
            navigator.clipboard.writeText(post)
                .then(() => alert('✅ Post Gerado e Copiado com SUCESSO!'))
                .catch(() => alert('Post gerado (copie do console)'));

            console.log(post);
        }

        // Event listeners para calcular em tempo real
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('milhas')?.addEventListener('input', calcularCustoTotal);
            document.getElementById('valorMilheiro')?.addEventListener('input', calcularCustoTotal);
            document.getElementById('taxas')?.addEventListener('input', calcularCustoTotal);
        });

        // ===== COMPARADOR DE COMPANHIAS =====

        function atualizarComparador() {
            const filtroItinerario = document.getElementById('filtro_comparador')?.value.toLowerCase() || '';

            // Combinar ativos e histórico
            const todosDados = [...agendamentos, ...historico];

            let dadosFiltrados = todosDados;
            if (filtroItinerario) {
                dadosFiltrados = todosDados.filter(d => d.itinerario.toLowerCase().includes(filtroItinerario));
            }

            const companhias = ['Azul', 'Smiles', 'Latam'];
            const estatisticas = {};

            companhias.forEach(cia => {
                const dados = dadosFiltrados.filter(d => d.companhia === cia);

                if (dados.length === 0) {
                    estatisticas[cia] = null;
                    return;
                }

                // Média de milhas
                const dadosComMilhas = dados.filter(d => d.milhas && d.milhas.trim() !== '');
                let mediaMilhas = 0;
                if (dadosComMilhas.length > 0) {
                    const soma = dadosComMilhas.reduce((acc, d) => {
                        const valor = parseFloat(d.milhas.replace(/[^\d]/g, ''));
                        return acc + (isNaN(valor) ? 0 : valor);
                    }, 0);
                    mediaMilhas = Math.round(soma / dadosComMilhas.length);
                }

                // Média de taxas
                const dadosComTaxas = dados.filter(d => d.taxas && d.taxas.trim() !== '');
                let mediaTaxas = 0;
                if (dadosComTaxas.length > 0) {
                    const soma = dadosComTaxas.reduce((acc, d) => {
                        const valor = parseFloat(d.taxas.replace(/[^\d,]/g, '').replace(',', '.'));
                        return acc + (isNaN(valor) ? 0 : valor);
                    }, 0);
                    mediaTaxas = soma / dadosComTaxas.length;
                }

                const custoTotal = (mediaMilhas * cotacaoMilha) + mediaTaxas;

                estatisticas[cia] = {
                    total: dados.length,
                    mediaMilhas: mediaMilhas,
                    mediaTaxas: mediaTaxas,
                    custoTotal: custoTotal
                };
            });

            let html = '';

            if (Object.values(estatisticas).every(e => e === null)) {
                html = '<div class="empty-state"><h3>Nenhum dado disponível</h3><p>Cadastre agendamentos para ver as estatísticas</p></div>';
            } else {
                html += '<div class="stats-grid">';

                companhias.forEach(cia => {
                    const stats = estatisticas[cia];
                    if (!stats) {
                        html += `
                            <div class="stat-card" style="opacity: 0.5;">
                                <h3>${cia}</h3>
                                <div class="value" style="font-size: 1.5em;">Sem dados</div>
                            </div>
                        `;
                        return;
                    }

                    html += `
                        <div class="stat-card">
                            <h3>${cia}</h3>
                            <div class="value" style="font-size: 1.3em; margin-bottom: 10px;">R$ ${stats.custoTotal.toFixed(2)}</div>
                            <p style="color: #b0b0b0; font-size: 0.85em; margin: 5px 0;">
                                <strong>Milhas:</strong> ${stats.mediaMilhas.toLocaleString('pt-BR')}<br>
                                <strong>Taxas:</strong> R$ ${stats.mediaTaxas.toFixed(2)}<br>
                                <strong>Registros:</strong> ${stats.total}
                            </p>
                        </div>
                    `;
                });

                html += '</div>';

                // Encontrar melhor opção
                const validos = Object.entries(estatisticas).filter(([_, v]) => v !== null);
                if (validos.length > 0) {
                    const melhor = validos.reduce((min, [cia, stats]) =>
                        stats.custoTotal < min.stats.custoTotal ? {cia, stats} : min
                    , {cia: validos[0][0], stats: validos[0][1]});

                    html += `
                        <div class="info-text" style="margin-top: 20px;">
                            <strong>*** Melhor Custo-Benefício:</strong> ${melhor.cia} com custo médio de R$ ${melhor.stats.custoTotal.toFixed(2)}
                        </div>
                    `;
                }
            }

            document.getElementById('comparadorCompanhias').innerHTML = html;
        }

        // ===== ANÁLISE DE SAZONALIDADE =====

        function atualizarSazonalidade() {
            const regiaoFiltro = document.getElementById('filtro_sazonalidade')?.value || 'todas';

            const todosDados = [...agendamentos, ...historico];
            let dadosFiltrados = todosDados;

            if (regiaoFiltro !== 'todas') {
                dadosFiltrados = todosDados.filter(d => d.regiao === regiaoFiltro);
            }

            // Agrupar por mês
            const meses = {
                '01': 'Janeiro', '02': 'Fevereiro', '03': 'Março', '04': 'Abril',
                '05': 'Maio', '06': 'Junho', '07': 'Julho', '08': 'Agosto',
                '09': 'Setembro', '10': 'Outubro', '11': 'Novembro', '12': 'Dezembro'
            };

            const porMes = {};
            Object.keys(meses).forEach(m => porMes[m] = 0);

            dadosFiltrados.forEach(d => {
                if (d.data_cadastro) {
                    const [dia, mes, ano] = d.data_cadastro.split('/');
                    if (mes && porMes[mes] !== undefined) {
                        porMes[mes]++;
                    }
                }
            });

            const total = Object.values(porMes).reduce((a, b) => a + b, 0);

            let html = '';

            if (total === 0) {
                html = '<div class="empty-state"><h3>Nenhum dado disponível</h3><p>Aguarde até ter histórico com datas de cadastro</p></div>';
            } else {
                html += '<p style="color: #b0b0b0; margin-bottom: 20px;">Quantidade de promoções cadastradas por mês</p>';

                Object.entries(porMes).forEach(([mes, qtd]) => {
                    const percent = total > 0 ? (qtd / total * 100).toFixed(1) : 0;
                    const larguraBarra = total > 0 ? (qtd / total * 100) : 0;

                    html += `
                        <div class="distribuicao-box" style="position: relative; overflow: hidden;">
                            <div style="position: absolute; left: 0; top: 0; bottom: 0; width: ${larguraBarra}%; background: rgba(212, 175, 55, 0.15); z-index: 0;"></div>
                            <span style="position: relative; z-index: 1;">${meses[mes]}</span>
                            <span style="position: relative; z-index: 1;">${qtd}</span>
                            <span style="position: relative; z-index: 1;">${percent}%</span>
                        </div>
                    `;
                });

                // Destacar melhor mês
                const melhorMes = Object.entries(porMes).reduce((max, [mes, qtd]) =>
                    qtd > max.qtd ? {mes, qtd} : max
                , {mes: '01', qtd: 0});

                if (melhorMes.qtd > 0) {
                    html += `
                        <div class="info-text" style="margin-top: 20px;">
                            <strong>*** Mês com Mais Promoções:</strong> ${meses[melhorMes.mes]} com ${melhorMes.qtd} registros (${(melhorMes.qtd / total * 100).toFixed(1)}%)
                        </div>
                    `;
                }
            }

            document.getElementById('sazonalidade').innerHTML = html;
        }

        // ===== EXPORTAR PARA REDES SOCIAIS =====

        function gerarPostRedeSocial(agendamento) {
            const itinerario = agendamento.itinerario;
            const companhia = agendamento.companhia || '';

            // Calcular valor em REAL (não mostrar milhas)
            let valorReal = 'Consultar';
            if (agendamento.milhas && agendamento.valorMilheiro) {
                const milhasNum = parseFloat(agendamento.milhas.replace(/[^\d]/g, ''));
                const valorMilheiroNum = parseFloat(agendamento.valorMilheiro.replace(/[^\d,]/g, '').replace(',', '.'));
                const taxasNum = agendamento.taxas ? parseFloat(agendamento.taxas.replace(/[^\d,]/g, '').replace(',', '.')) : 0;
                const custoMilhas = (milhasNum / 1000) * valorMilheiroNum;
                const total = custoMilhas + taxasNum;
                valorReal = 'R$ ' + total.toFixed(2).replace('.', ',');
            }

            const post = `🔥 ALERTA DE PASSAGEM 🔥

✈️ ${itinerario}
💰 ${valorReal}
${companhia ? '🏢 ' + companhia : ''}

⚠️ Poucas tarifas disponíveis!

${agendamento.link || ''}`;

            // Copiar para clipboard
            navigator.clipboard.writeText(post).then(() => {
                alert('Post copiado para área de transferência!\n\nCole agora no WhatsApp, Instagram ou Telegram!');
            }).catch(() => {
                // Fallback: mostrar em alert
                alert('Post gerado:\n\n' + post);
            });
        }

        // ===== FUNÇÕES DE COTAÇÃO =====

        // Base de dados de códigos IATA
        const aeroportosIATA = {
            // Brasil - Principais
            'GRU': 'São Paulo - Guarulhos (GRU)',
            'CGH': 'São Paulo - Congonhas (CGH)',
            'VCP': 'Campinas - Viracopos (VCP)',
            'GIG': 'Rio de Janeiro - Galeão (GIG)',
            'SDU': 'Rio de Janeiro - Santos Dumont (SDU)',
            'BSB': 'Brasília (BSB)',
            'CNF': 'Belo Horizonte - Confins (CNF)',
            'PLU': 'Belo Horizonte - Pampulha (PLU)',
            'SSA': 'Salvador (SSA)',
            'REC': 'Recife (REC)',
            'FOR': 'Fortaleza (FOR)',
            'CWB': 'Curitiba - Afonso Pena (CWB)',
            'POA': 'Porto Alegre (POA)',
            'FLN': 'Florianópolis (FLN)',
            'MAO': 'Manaus (MAO)',
            'BEL': 'Belém (BEL)',
            'NAT': 'Natal (NAT)',
            'MCZ': 'Maceió (MCZ)',
            'VIX': 'Vitória (VIX)',
            'CGB': 'Cuiabá (CGB)',
            'IGU': 'Foz do Iguaçu (IGU)',
            'GYN': 'Goiânia (GYN)',
            'AJU': 'Aracaju (AJU)',
            'THE': 'Teresina (THE)',
            'SLZ': 'São Luís (SLZ)',
            'JPA': 'João Pessoa (JPA)',
            'CGR': 'Campo Grande (CGR)',
            'CXJ': 'Caxias do Sul (CXJ)',
            'NVT': 'Navegantes (NVT)',
            'IOS': 'Ilhéus (IOS)',
            'PVH': 'Porto Velho (PVH)',
            'RBR': 'Rio Branco (RBR)',
            'BVB': 'Boa Vista (BVB)',
            'PNZ': 'Petrolina (PNZ)',
            'JDO': 'Juazeiro do Norte (JDO)',

            // Europa
            'LIS': 'Lisboa (LIS)',
            'OPO': 'Porto (OPO)',
            'MAD': 'Madrid (MAD)',
            'BCN': 'Barcelona (BCN)',
            'LHR': 'Londres - Heathrow (LHR)',
            'LGW': 'Londres - Gatwick (LGW)',
            'CDG': 'Paris - Charles de Gaulle (CDG)',
            'ORY': 'Paris - Orly (ORY)',
            'FCO': 'Roma - Fiumicino (FCO)',
            'MXP': 'Milão - Malpensa (MXP)',
            'AMS': 'Amsterdam (AMS)',
            'FRA': 'Frankfurt (FRA)',
            'MUC': 'Munique (MUC)',
            'ZRH': 'Zurique (ZRH)',
            'VIE': 'Viena (VIE)',
            'ATH': 'Atenas (ATH)',
            'IST': 'Istambul (IST)',
            'DUB': 'Dublin (DUB)',
            'BRU': 'Bruxelas (BRU)',
            'CPH': 'Copenhague (CPH)',
            'OSL': 'Oslo (OSL)',
            'ARN': 'Estocolmo (ARN)',
            'HEL': 'Helsinque (HEL)',
            'WAW': 'Varsóvia (WAW)',
            'PRG': 'Praga (PRG)',
            'BUD': 'Budapeste (BUD)',

            // América do Norte
            'JFK': 'Nova York - JFK (JFK)',
            'EWR': 'Nova York - Newark (EWR)',
            'LGA': 'Nova York - LaGuardia (LGA)',
            'MIA': 'Miami (MIA)',
            'FLL': 'Fort Lauderdale (FLL)',
            'MCO': 'Orlando (MCO)',
            'LAX': 'Los Angeles (LAX)',
            'SFO': 'San Francisco (SFO)',
            'ORD': 'Chicago - O\'Hare (ORD)',
            'DFW': 'Dallas (DFW)',
            'IAH': 'Houston (IAH)',
            'ATL': 'Atlanta (ATL)',
            'BOS': 'Boston (BOS)',
            'DEN': 'Denver (DEN)',
            'SEA': 'Seattle (SEA)',
            'LAS': 'Las Vegas (LAS)',
            'PHX': 'Phoenix (PHX)',
            'YYZ': 'Toronto (YYZ)',
            'YUL': 'Montreal (YUL)',
            'YVR': 'Vancouver (YVR)',
            'MEX': 'Cidade do México (MEX)',
            'CUN': 'Cancún (CUN)',
            'PTY': 'Panamá City (PTY)',

            // América do Sul
            'EZE': 'Buenos Aires - Ezeiza (EZE)',
            'AEP': 'Buenos Aires - Aeroparque (AEP)',
            'SCL': 'Santiago (SCL)',
            'LIM': 'Lima (LIM)',
            'BOG': 'Bogotá (BOG)',
            'UIO': 'Quito (UIO)',
            'GYE': 'Guayaquil (GYE)',
            'CCS': 'Caracas (CCS)',
            'ASU': 'Assunção (ASU)',
            'MVD': 'Montevidéu (MVD)',

            // Ásia
            'DXB': 'Dubai (DXB)',
            'DOH': 'Doha (DOH)',
            'SIN': 'Singapura (SIN)',
            'HKG': 'Hong Kong (HKG)',
            'NRT': 'Tóquio - Narita (NRT)',
            'ICN': 'Seul (ICN)',
            'PEK': 'Pequim (PEK)',
            'PVG': 'Xangai (PVG)',
            'BKK': 'Bangkok (BKK)',
            'DEL': 'Nova Delhi (DEL)',

            // Oceania
            'SYD': 'Sydney (SYD)',
            'MEL': 'Melbourne (MEL)',
            'AKL': 'Auckland (AKL)',

            // África
            'JNB': 'Joanesburgo (JNB)',
            'CPT': 'Cidade do Cabo (CPT)',
            'CAI': 'Cairo (CAI)',
            'ADD': 'Adis Abeba (ADD)'
        };

        function autoCompletarAeroporto(inputId) {
            const input = document.getElementById(inputId);
            const valor = input.value.trim().toUpperCase();

            if (aeroportosIATA[valor]) {
                input.value = aeroportosIATA[valor];
            }
        }

        function toggleConexaoIda() {
            const tem = document.getElementById('cotacao_conexaoIda').value;
            document.getElementById('detalhesConexaoIda').style.display = tem === 'sim' ? 'block' : 'none';
            if (tem === 'sim') {
                mostrarParadasIda(); // Mostrar paradas quando abrir
            }
        }

        function toggleConexaoVolta() {
            const tem = document.getElementById('cotacao_conexaoVolta').value;
            document.getElementById('detalhesConexaoVolta').style.display = tem === 'sim' ? 'block' : 'none';
            if (tem === 'sim') {
                mostrarParadasVolta(); // Mostrar paradas quando abrir
            }
        }

        function mostrarParadasIda() {
            const numParadas = parseInt(document.getElementById('cotacao_numParadasIda').value);

            document.getElementById('parada1Ida').style.display = 'block';
            document.getElementById('parada2Ida').style.display = numParadas >= 2 ? 'block' : 'none';
            document.getElementById('parada3Ida').style.display = numParadas >= 3 ? 'block' : 'none';
        }

        function mostrarParadasVolta() {
            const numParadas = parseInt(document.getElementById('cotacao_numParadasVolta').value);

            document.getElementById('parada1Volta').style.display = 'block';
            document.getElementById('parada2Volta').style.display = numParadas >= 2 ? 'block' : 'none';
            document.getElementById('parada3Volta').style.display = numParadas >= 3 ? 'block' : 'none';
        }

        function toggleVolta() {
            const tipo = document.getElementById('cotacao_tipoViagem').value;
            const secaoVolta = document.getElementById('secaoVolta');

            if (tipo === 'somente-ida') {
                secaoVolta.style.display = 'none';
            } else {
                secaoVolta.style.display = 'block';
            }
        }

        function atualizarTotalPassageiros() {
            const adultos = parseInt(document.getElementById('cotacao_adultos').value) || 0;
            const criancas = parseInt(document.getElementById('cotacao_criancas').value) || 0;
            const bebes = parseInt(document.getElementById('cotacao_bebes').value) || 0;

            let texto = [];
            if (adultos > 0) texto.push(`${adultos} adulto${adultos > 1 ? 's' : ''}`);
            if (criancas > 0) texto.push(`${criancas} criança${criancas > 1 ? 's' : ''}`);
            if (bebes > 0) texto.push(`${bebes} bebê${bebes > 1 ? 's' : ''}`);

            document.getElementById('cotacao_numPassageiros').value = texto.join(', ');
        }

        function preencherBagagem() {
            const tarifa = document.getElementById('cotacao_tipoTarifa').value;
            const campoBagagem = document.getElementById('cotacao_bagagem');

            const bagagens = {
                'Básica': '1 bolsa ou mochila (por pessoa)\nSem direito a mala despachada',
                'Light': '1 bolsa ou mochila até 10 kg (por pessoa)\n1 mala pequena até 12 kg (por pessoa)\nSujeita a ser despachada no embarque',
                'Standard': '1 bolsa ou mochila até 10 kg (por pessoa)\nDeve ser acomodada no assento da frente\n1 bagagem despachada 23 kg (por pessoa)\nRemarcação com taxa - diferença de preço',
                'Plus': '1 bolsa ou mochila até 10 kg (por pessoa)\nDeve ser acomodada no assento da frente\n1 bagagem despachada 23 kg (por pessoa)\nRemarcação com taxa - diferença de preço\nReembolso antes da partida do primeiro voo',
                'Executiva': '1 bolsa ou mochila até 10 kg (por pessoa)\n1 bagagem despachada 23 kg (por pessoa)\nRemarcação sem taxa - diferença de preço\nSeleção de assento comum\nSolicitação de upgrade de cabine com trechos'
            };

            campoBagagem.value = bagagens[tarifa] || '';
        }

        function calcularTempoVooIda() {
            const horaSaida = document.getElementById('cotacao_horaSaidaIda').value;
            const horaChegada = document.getElementById('cotacao_horaChegadaIda').value;
            const dataIda = document.getElementById('cotacao_dataIda').value;

            if (!horaSaida || !horaChegada || !dataIda) return;

            const [horaSaidaH, horaSaidaM] = horaSaida.split(':').map(Number);
            const [horaChegadaH, horaChegadaM] = horaChegada.split(':').map(Number);

            let inicio = new Date(dataIda + 'T' + horaSaida);
            let fim = new Date(dataIda + 'T' + horaChegada);

            // Se hora de chegada for menor que saída, adiciona 1 dia
            if (fim < inicio) {
                fim.setDate(fim.getDate() + 1);
            }

            const diffMs = fim - inicio;
            const diffHoras = Math.floor(diffMs / (1000 * 60 * 60));
            const diffMinutos = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));

            const tempoTexto = `${diffHoras}h ${diffMinutos}min`;
            document.getElementById('cotacao_tempoVooIda').value = tempoTexto;
        }

        function calcularTempoVooVolta() {
            const horaSaida = document.getElementById('cotacao_horaSaidaVolta').value;
            const horaChegada = document.getElementById('cotacao_horaChegadaVolta').value;
            const dataVolta = document.getElementById('cotacao_dataVolta').value;

            if (!horaSaida || !horaChegada || !dataVolta) return;

            const [horaSaidaH, horaSaidaM] = horaSaida.split(':').map(Number);
            const [horaChegadaH, horaChegadaM] = horaChegada.split(':').map(Number);

            let inicio = new Date(dataVolta + 'T' + horaSaida);
            let fim = new Date(dataVolta + 'T' + horaChegada);

            // Se hora de chegada for menor que saída, adiciona 1 dia
            if (fim < inicio) {
                fim.setDate(fim.getDate() + 1);
            }

            const diffMs = fim - inicio;
            const diffHoras = Math.floor(diffMs / (1000 * 60 * 60));
            const diffMinutos = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));

            const tempoTexto = `${diffHoras}h ${diffMinutos}min`;
            document.getElementById('cotacao_tempoVooVolta').value = tempoTexto;
        }

        function atualizarInfoCalculoMilhas() {
            const companhia = document.getElementById('cotacao_companhia').value;
            const infoElement = document.getElementById('infoCalculoMilhas');

            if (companhia === 'LATAM') {
                infoElement.textContent = '⚠️ Valor POR PESSOA (será multiplicado pelo número de passageiros)';
                infoElement.style.color = '#4CAF50';
            } else if (companhia === 'GOL' || companhia === 'Azul') {
                infoElement.textContent = '⚠️ Valor TOTAL (NÃO multiplica, já é o valor final)';
                infoElement.style.color = '#FF9800';
            } else {
                infoElement.textContent = '';
            }
        }

        function calcularCotacao() {
            const milhasInput = document.getElementById('cotacao_milhas').value;
            const valorMilheiroInput = document.getElementById('cotacao_valorMilheiro').value;
            const taxasInput = document.getElementById('cotacao_taxas').value;
            const adultos = parseInt(document.getElementById('cotacao_adultos').value) || 0;
            const criancas = parseInt(document.getElementById('cotacao_criancas').value) || 0;
            const bebes = parseInt(document.getElementById('cotacao_bebes').value) || 0;
            const numPassageiros = adultos + criancas + bebes;
            const companhia = document.getElementById('cotacao_companhia').value;

            if (!milhasInput || !valorMilheiroInput) {
                document.getElementById('cotacao_valorPessoa').textContent = '-';
                document.getElementById('cotacao_valorTotal').textContent = '-';
                document.getElementById('cotacao_parcela').textContent = '-';
                document.getElementById('cotacao_totalParcelado').textContent = '-';
                return;
            }

            const milhasNum = parseFloat(milhasInput.replace(/[^\d]/g, ''));
            const valorMilheiroNum = parseFloat(valorMilheiroInput.replace(/[^\d,]/g, '').replace(',', '.'));
            const taxasNum = taxasInput ? parseFloat(taxasInput.replace(/[^\d,]/g, '').replace(',', '.')) : 0;

            const custoMilhas = (milhasNum / 1000) * valorMilheiroNum;

            // Verificar se é valor por pessoa ou total
            const valorPorPessoaMultiplica = (companhia === 'LATAM');

            let custoPorPessoa, custoTotalPix;

            if (valorPorPessoaMultiplica) {
                // LATAM: valor é POR PESSOA
                custoPorPessoa = custoMilhas + (isNaN(taxasNum) ? 0 : taxasNum);
                custoTotalPix = custoPorPessoa * numPassageiros;
            } else {
                // GOL (Smiles) e Azul: valor JÁ É O TOTAL
                custoTotalPix = custoMilhas + (isNaN(taxasNum) ? 0 : taxasNum);
                custoPorPessoa = custoTotalPix / numPassageiros;
            }

            const custoTotalCartao = custoTotalPix * 1.088;
            const parcelaCartao = custoTotalCartao / 5;

            document.getElementById('cotacao_valorPessoa').textContent = `R$ ${custoPorPessoa.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            document.getElementById('cotacao_valorTotal').textContent = `R$ ${custoTotalPix.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            document.getElementById('cotacao_parcela').textContent = `R$ ${parcelaCartao.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            document.getElementById('cotacao_totalParcelado').textContent = `R$ ${custoTotalCartao.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        }

        function copiarCotacaoWhatsApp() {
            // Validação básica
            const nomeCliente = document.getElementById('cotacao_nomeCliente').value;
            const origem = document.getElementById('cotacao_origem').value;
            const destino = document.getElementById('cotacao_destino').value;

            if (!nomeCliente || !origem || !destino) {
                alert('Preencha pelo menos: Nome do Cliente, Origem e Destino');
                return;
            }

            calcularCotacao(); // Garantir que valores estão atualizados

            const numPassageiros = document.getElementById('cotacao_numPassageiros').value;
            const companhia = document.getElementById('cotacao_companhia').value;
            const tipoTarifa = document.getElementById('cotacao_tipoTarifa').value;
            const dataIda = document.getElementById('cotacao_dataIda').value;
            const horaSaidaIda = document.getElementById('cotacao_horaSaidaIda').value;
            const horaChegadaIda = document.getElementById('cotacao_horaChegadaIda').value;
            const conexaoIda = document.getElementById('cotacao_conexaoIda').value;

            // Paradas IDA
            let paradasIdaTexto = 'Voo direto';
            if (conexaoIda === 'sim') {
                const numParadasIda = parseInt(document.getElementById('cotacao_numParadasIda').value);
                let paradas = [];

                for (let i = 1; i <= numParadasIda; i++) {
                    const cidade = document.getElementById(`cotacao_parada${i}CidadeIda`).value;
                    const tempo = document.getElementById(`cotacao_parada${i}TempoIda`).value;
                    if (cidade) {
                        paradas.push(tempo ? `${cidade} (${tempo})` : cidade);
                    }
                }

                if (paradas.length > 0) {
                    paradasIdaTexto = `${paradas.length} ${paradas.length === 1 ? 'parada' : 'paradas'}: ${paradas.join(', ')}`;
                }
            }

            const dataVolta = document.getElementById('cotacao_dataVolta').value;
            const horaSaidaVolta = document.getElementById('cotacao_horaSaidaVolta').value;
            const horaChegadaVolta = document.getElementById('cotacao_horaChegadaVolta').value;
            const conexaoVolta = document.getElementById('cotacao_conexaoVolta').value;

            // Paradas VOLTA
            let paradasVoltaTexto = 'Voo direto';
            if (conexaoVolta === 'sim') {
                const numParadasVolta = parseInt(document.getElementById('cotacao_numParadasVolta').value);
                let paradas = [];

                for (let i = 1; i <= numParadasVolta; i++) {
                    const cidade = document.getElementById(`cotacao_parada${i}CidadeVolta`).value;
                    const tempo = document.getElementById(`cotacao_parada${i}TempoVolta`).value;
                    if (cidade) {
                        paradas.push(tempo ? `${cidade} (${tempo})` : cidade);
                    }
                }

                if (paradas.length > 0) {
                    paradasVoltaTexto = `${paradas.length} ${paradas.length === 1 ? 'parada' : 'paradas'}: ${paradas.join(', ')}`;
                }
            }

            const valorPessoa = document.getElementById('cotacao_valorPessoa').textContent;
            const valorTotal = document.getElementById('cotacao_valorTotal').textContent;
            const parcela = document.getElementById('cotacao_parcela').textContent;
            const totalParcelado = document.getElementById('cotacao_totalParcelado').textContent;

            const bagagem = document.getElementById('cotacao_bagagem').value;

            // Formatar datas
            const dataIdaFormatada = dataIda ? new Date(dataIda + 'T00:00:00').toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' }) : '';
            const dataVoltaFormatada = dataVolta ? new Date(dataVolta + 'T00:00:00').toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' }) : '';
            const diaSemanaIda = dataIda ? new Date(dataIda + 'T00:00:00').toLocaleDateString('pt-BR', { weekday: 'long' }).toUpperCase() : '';
            const diaSemanaVolta = dataVolta ? new Date(dataVolta + 'T00:00:00').toLocaleDateString('pt-BR', { weekday: 'long' }).toUpperCase() : '';

            const tempoVooIda = document.getElementById('cotacao_tempoVooIda').value || '';
            const tempoVooVolta = document.getElementById('cotacao_tempoVooVolta').value || '';
            const tipoViagem = document.getElementById('cotacao_tipoViagem').value;

            const simboloRota = tipoViagem === 'somente-ida' ? '→' : '↔';

            let voltaTexto = '';
            if (tipoViagem === 'ida-volta' && dataVolta) {
                voltaTexto = `✈️ *VOLTA: ${dataVoltaFormatada} – ${diaSemanaVolta}*
${horaSaidaVolta} (${destino}) → ${horaChegadaVolta} (${origem})${tempoVooVolta ? `\n⏱️ Tempo de voo: ${tempoVooVolta}` : ''}
*${paradasVoltaTexto}*
────
`;
            }

            const post = `────
*${origem.toUpperCase()} ${simboloRota} ${destino.toUpperCase()}*
────
${companhia}
*${numPassageiros}*
────
${tipoTarifa ? `*TARIFA ${tipoTarifa.toUpperCase()}*\n────\n` : ''}💰 *VALORES*

*${valorPessoa}* por pessoa

💵 *PIX*
*${valorTotal}* Total

💳 *CARTÃO*
*5x de ${parcela}*
_${totalParcelado} total parcelado_
────
✈️ *IDA: ${dataIdaFormatada} – ${diaSemanaIda}*
${horaSaidaIda} (${origem}) → ${horaChegadaIda} (${destino})${tempoVooIda ? `\n⏱️ Tempo de voo: ${tempoVooIda}` : ''}
*${paradasIdaTexto}*
────
${voltaTexto}${bagagem ? `🧳 *Bagagem (por pessoa)*\n${bagagem}\n────\n` : ''}✅ Taxas inclusas
────
⚠️ AS *TARIFAS SÃO DINÂMICAS* E PODEM SOFRER ALTERAÇÕES SEM AVISO PRÉVIO POR PARTE DA COMPANHIA AÉREA.
────`;

            navigator.clipboard.writeText(post).then(() => {
                alert('Cotação copiada para WhatsApp!\n\nAgora cole no WhatsApp do cliente.');
                console.log(post);
            }).catch(() => {
                alert('Cotação gerada (copie do console):\n\n' + post);
            });
        }

        function gerarPDFCotacao() {
            console.log('gerarPDFCotacao chamada');
            console.log('window.jspdf:', window.jspdf);

            const nomeCliente = document.getElementById('cotacao_nomeCliente').value;
            const numPassageiros = document.getElementById('cotacao_numPassageiros').value;
            const origem = document.getElementById('cotacao_origem').value;
            const destino = document.getElementById('cotacao_destino').value;
            const companhia = document.getElementById('cotacao_companhia').value;
            const tipoTarifa = document.getElementById('cotacao_tipoTarifa').value;

            const dataIda = document.getElementById('cotacao_dataIda').value;
            const horaSaidaIda = document.getElementById('cotacao_horaSaidaIda').value;
            const horaChegadaIda = document.getElementById('cotacao_horaChegadaIda').value;
            const conexaoIda = document.getElementById('cotacao_conexaoIda').checked;
            const conexaoTextoIda = document.getElementById('cotacao_conexaoTextoIda').value;

            const dataVolta = document.getElementById('cotacao_dataVolta').value;
            const horaSaidaVolta = document.getElementById('cotacao_horaSaidaVolta').value;
            const horaChegadaVolta = document.getElementById('cotacao_horaChegadaVolta').value;
            const conexaoVolta = document.getElementById('cotacao_conexaoVolta').checked;
            const conexaoTextoVolta = document.getElementById('cotacao_conexaoTextoVolta').value;

            const bagagem = document.getElementById('cotacao_bagagem').value;

            const valorPessoa = document.getElementById('cotacao_valorPessoa').textContent;
            const valorTotal = document.getElementById('cotacao_valorTotal').textContent;
            const parcela = document.getElementById('cotacao_parcela').textContent;
            const totalParcelado = document.getElementById('cotacao_totalParcelado').textContent;

            if (!nomeCliente || !origem || !destino || !companhia || !dataIda || !dataVolta) {
                alert('Preencha todos os campos obrigatórios antes de gerar o PDF.');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();

            // Barra dourada no topo
            doc.setFillColor(218, 165, 32);
            doc.rect(0, 0, pageWidth, 25, 'F');

            // Logo/Nome da empresa
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(22);
            doc.setFont('helvetica', 'bold');
            doc.text('VOECOMKENNEDY', pageWidth / 2, 12, { align: 'center' });

            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text('Passagens Aéreas', pageWidth / 2, 18, { align: 'center' });

            // Contato
            doc.setFontSize(8);
            doc.text('WhatsApp: (35) 98829-2395 | Email: contato@voecomkennedy.com.br', pageWidth / 2, 23, { align: 'center' });

            // Título do documento
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            doc.text('ORÇAMENTO DE VIAGEM', pageWidth / 2, 35, { align: 'center' });

            // Linha separadora
            doc.setDrawColor(218, 165, 32);
            doc.setLineWidth(0.5);
            doc.line(15, 40, pageWidth - 15, 40);

            let yPos = 50;

            // Dados do Cliente
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text('DADOS DO CLIENTE', 15, yPos);
            yPos += 7;

            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text(`Cliente: ${nomeCliente}`, 15, yPos);
            yPos += 6;
            doc.text(`Número de Passageiros: ${numPassageiros}`, 15, yPos);
            yPos += 10;

            // Detalhes do Voo
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text('DETALHES DO VOO', 15, yPos);
            yPos += 7;

            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text(`Origem: ${origem.toUpperCase()}`, 15, yPos);
            yPos += 6;
            doc.text(`Destino: ${destino.toUpperCase()}`, 15, yPos);
            yPos += 6;
            doc.text(`Companhia Aérea: ${companhia}`, 15, yPos);
            yPos += 6;
            if (tipoTarifa) {
                doc.text(`Tipo de Tarifa: ${tipoTarifa}`, 15, yPos);
                yPos += 6;
            }
            yPos += 5;

            // Voo de IDA
            doc.setFontSize(11);
            doc.setFont('helvetica', 'bold');
            const dataIdaFormatada = new Date(dataIda + 'T00:00:00').toLocaleDateString('pt-BR', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            doc.text(`VOO DE IDA - ${dataIdaFormatada}`, 15, yPos);
            yPos += 6;

            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text(`Saída: ${horaSaidaIda} (${origem})`, 15, yPos);
            yPos += 6;
            doc.text(`Chegada: ${horaChegadaIda} (${destino})`, 15, yPos);
            yPos += 6;

            if (conexaoIda && conexaoTextoIda) {
                doc.setFont('helvetica', 'italic');
                doc.text(`Conexão: ${conexaoTextoIda}`, 15, yPos);
                yPos += 6;
                doc.setFont('helvetica', 'normal');
            } else {
                doc.text('Voo Direto', 15, yPos);
                yPos += 6;
            }
            yPos += 5;

            // Voo de VOLTA
            doc.setFontSize(11);
            doc.setFont('helvetica', 'bold');
            const dataVoltaFormatada = new Date(dataVolta + 'T00:00:00').toLocaleDateString('pt-BR', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            doc.text(`VOO DE VOLTA - ${dataVoltaFormatada}`, 15, yPos);
            yPos += 6;

            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text(`Saída: ${horaSaidaVolta} (${destino})`, 15, yPos);
            yPos += 6;
            doc.text(`Chegada: ${horaChegadaVolta} (${origem})`, 15, yPos);
            yPos += 6;

            if (conexaoVolta && conexaoTextoVolta) {
                doc.setFont('helvetica', 'italic');
                doc.text(`Conexão: ${conexaoTextoVolta}`, 15, yPos);
                yPos += 6;
                doc.setFont('helvetica', 'normal');
            } else {
                doc.text('Voo Direto', 15, yPos);
                yPos += 6;
            }
            yPos += 5;

            // Bagagem
            if (bagagem) {
                doc.setFontSize(11);
                doc.setFont('helvetica', 'bold');
                doc.text('BAGAGEM INCLUÍDA (por pessoa)', 15, yPos);
                yPos += 6;

                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                const linhasBagagem = doc.splitTextToSize(bagagem, pageWidth - 30);
                doc.text(linhasBagagem, 15, yPos);
                yPos += (linhasBagagem.length * 6) + 5;
            }

            // Valores
            doc.setFillColor(240, 240, 240);
            doc.rect(15, yPos - 3, pageWidth - 30, 35, 'F');

            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text('VALORES', 20, yPos + 5);
            yPos += 12;

            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text(`Valor por Pessoa: ${valorPessoa}`, 20, yPos);
            yPos += 6;
            doc.text(`Total (PIX): ${valorTotal}`, 20, yPos);
            yPos += 6;
            doc.text(`Parcelado em 5x: ${parcela} (Total: ${totalParcelado})`, 20, yPos);
            yPos += 6;
            doc.setFontSize(8);
            doc.setFont('helvetica', 'italic');
            doc.text('Taxas inclusas', 20, yPos);
            yPos += 12;

            // Aviso importante
            doc.setFontSize(9);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(200, 0, 0);
            const avisoLinhas = doc.splitTextToSize('AS TARIFAS SÃO DINÂMICAS E PODEM SOFRER ALTERAÇÕES SEM AVISO PRÉVIO POR PARTE DA COMPANHIA AÉREA.', pageWidth - 30);
            doc.text(avisoLinhas, pageWidth / 2, yPos, { align: 'center' });

            // Rodapé
            doc.setTextColor(150, 150, 150);
            doc.setFontSize(8);
            doc.setFont('helvetica', 'italic');
            const dataGeracao = new Date().toLocaleString('pt-BR');
            doc.text(`Orçamento gerado em: ${dataGeracao}`, pageWidth / 2, pageHeight - 10, { align: 'center' });

            // Salvar PDF
            const nomeArquivo = `Orcamento_${nomeCliente.replace(/\s+/g, '_')}_${origem}-${destino}_${new Date().getTime()}.pdf`;
            doc.save(nomeArquivo);

            alert('PDF gerado com sucesso!');
        }

        function salvarCotacao() {
            const nomeCliente = document.getElementById('cotacao_nomeCliente').value;
            const origem = document.getElementById('cotacao_origem').value;
            const destino = document.getElementById('cotacao_destino').value;

            if (!nomeCliente || !origem || !destino) {
                alert('Preencha pelo menos: Nome, Origem e Destino');
                return;
            }

            const agora = new Date();
            const dataCotacao = agora.toLocaleDateString('pt-BR');
            const horaCotacao = agora.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });

            const cotacao = {
                data_cotacao: dataCotacao,
                hora_cotacao: horaCotacao,
                nomeCliente: nomeCliente,
                numPassageiros: document.getElementById('cotacao_numPassageiros').value,
                origem: origem,
                destino: destino,
                companhia: document.getElementById('cotacao_companhia').value,
                tipoTarifa: document.getElementById('cotacao_tipoTarifa').value,
                tipoViagem: document.getElementById('cotacao_tipoViagem').value,
                linkCompanhia: document.getElementById('cotacao_linkCompanhia').value,
                dataIda: document.getElementById('cotacao_dataIda').value,
                horaSaidaIda: document.getElementById('cotacao_horaSaidaIda').value,
                horaChegadaIda: document.getElementById('cotacao_horaChegadaIda').value,
                tempoVooIda: document.getElementById('cotacao_tempoVooIda').value,
                conexaoIda: document.getElementById('cotacao_conexaoIda').value,
                dataVolta: document.getElementById('cotacao_dataVolta').value,
                horaSaidaVolta: document.getElementById('cotacao_horaSaidaVolta').value,
                horaChegadaVolta: document.getElementById('cotacao_horaChegadaVolta').value,
                tempoVooVolta: document.getElementById('cotacao_tempoVooVolta').value,
                conexaoVolta: document.getElementById('cotacao_conexaoVolta').value,
                milhas: document.getElementById('cotacao_milhas').value,
                valorMilheiro: document.getElementById('cotacao_valorMilheiro').value,
                taxas: document.getElementById('cotacao_taxas').value,
                valorPessoa: document.getElementById('cotacao_valorPessoa').textContent,
                valorTotal: document.getElementById('cotacao_valorTotal').textContent,
                bagagem: document.getElementById('cotacao_bagagem').value
            };

            cotacoes.push(cotacao);
            salvarDados();
            atualizarListaCotacoes();
            limparFormCotacao();
            alert('✅ Cotação salva com sucesso!');
        }

        function limparFormCotacao() {
            document.getElementById('formCotacao').reset();
            document.getElementById('cotacao_valorPessoa').textContent = '-';
            document.getElementById('cotacao_valorTotal').textContent = '-';
            document.getElementById('cotacao_parcela').textContent = '-';
            document.getElementById('cotacao_totalParcelado').textContent = '-';
        }

        function atualizarListaCotacoes() {
            if (cotacoes.length === 0) {
                document.getElementById('listaCotacoes').innerHTML = '<p style="color: #888;">Nenhuma cotação salva ainda.</p>';
                return;
            }

            let html = '<table><thead><tr><th>Data</th><th>Cliente</th><th>Rota</th><th>Passag.</th><th>Valor Total</th><th>Ações</th></tr></thead><tbody>';

            cotacoes.forEach((cot, index) => {
                html += `<tr>
                    <td>${cot.data_cotacao} ${cot.hora_cotacao}</td>
                    <td>${cot.nomeCliente}</td>
                    <td>${cot.origem} → ${cot.destino}</td>
                    <td>${cot.numPassageiros}</td>
                    <td style="font-weight: bold; color: #d4af37;">${cot.valorTotal}</td>
                    <td>
                        <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                            ${cot.linkCompanhia ? `<button class="btn btn-secondary" style="padding: 6px 12px; font-size: 0.8em;" onclick="window.open('${cot.linkCompanhia}', '_blank')">🔗 Ver Voo</button>` : ''}
                            <button class="btn btn-danger" style="padding: 6px 12px; font-size: 0.8em;" onclick="excluirCotacao(${index})">Excluir</button>
                        </div>
                    </td>
                </tr>`;
            });

            html += '</tbody></table>';
            document.getElementById('listaCotacoes').innerHTML = html;
        }

        function excluirCotacao(index) {
            if (confirm('Deseja excluir esta cotação?')) {
                cotacoes.splice(index, 1);
                salvarDados();
                atualizarListaCotacoes();
                alert('Cotação excluída!');
            }
        }

        function zerarSistema() {
            const confirmacao = confirm('ATENÇÃO!\n\nIsso vai APAGAR TODOS OS DADOS do sistema:\n\n- Todos os agendamentos\n- Todo o histórico\n- Todas as cotações salvas\n- Todas as configurações\n\nEsta ação NÃO PODE SER DESFEITA!\n\nTem certeza que deseja continuar?');

            if (!confirmacao) {
                return;
            }

            // Segunda confirmação para segurança
            const segundaConfirmacao = confirm('ÚLTIMA CONFIRMAÇÃO!\n\nVocê está prestes a ZERAR TODO O SISTEMA.\n\nClique em OK para confirmar ou Cancelar para voltar.');

            if (!segundaConfirmacao) {
                return;
            }

            // Limpar todas as variáveis
            agendamentos = [];
            historico = [];
            cotacoes = [];

            // Limpar localStorage
            localStorage.clear();

            // Recarregar listas vazias
            atualizarTudo();

            // Limpar forms
            document.getElementById('formAgendamento').reset();
            if (document.getElementById('formCotacao')) {
                document.getElementById('formCotacao').reset();
            }

            alert('Sistema zerado com sucesso!\n\nTodos os dados foram apagados.\n\nVocê pode começar do zero agora.');

            // Voltar para dashboard
            showTab('dashboard');
        }

        carregarDados();
    </script>
</body>
</html>
